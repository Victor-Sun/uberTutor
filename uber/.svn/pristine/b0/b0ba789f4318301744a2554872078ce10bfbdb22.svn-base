/**
 * 质量问题管理-问题列表（共通）
 */
Ext.define('ExtApp.view.qualityissuemanagement.issuelist.IssueList',{
	extend:'Ext.panel.Panel',
	xtype:'issueList',

	controller: 'issueList',

//	margin:10,
	cls:'shadow',
	
	layout: 'fit',
	
	initComponent: function() {
		var store = Ext.create('ExtApp.store.qualityissuemanagement.IssueListStore');
		store.getProxy().extraParams = {
			listType: this.listType
		};
		store.load();
		
//		项目
		var program = Ext.create('ExtApp.store.qualityissuemanagement.ProgramStore');
		program.load();
		
//		车型
		var programVehicleStore = Ext.create('ExtApp.store.qualityissuemanagement.ProgramVehicleStore');
		
//		责任部门
		var resDepartmentStore = Ext.create('ExtApp.store.qualityissuemanagement.ResDepartmentStore');
		
		// 问题状态
		var statusStore = Ext.create(
			'ExtApp.store.common.ImsCodeTableStore');
		statusStore.getProxy().extraParams = {type: 'ISSUE_STATUS'};
		statusStore.load();
		
		// 问题等级
		var levelStore = Ext.create(
			'ExtApp.store.common.ImsCodeTableStore');
		levelStore.getProxy().extraParams = {type: 'ISSUE_LEVEL'};
		levelStore.load();
		
		// 风险等级
		var riskStore = Ext.create(
			'ExtApp.store.common.ImsCodeTableStore');
		riskStore.getProxy().extraParams = {type: 'RISK_LEVEL'};
		riskStore.load();
		
		//问题类型
		var issueTypeStore = Ext.create('ExtApp.store.qualityissuemanagement.IssueTypeStore');
		issueTypeStore.load();
		//问题来源
		var problemSource = Ext.create('ExtApp.store.qualityissuemanagement.ProblemSourceStore');
		problemSource.load();
		
		//问题性质
		var issueNatureStore = Ext.create('ExtApp.store.qualityissuemanagement.IssueNatureStore');
		issueNatureStore.load();
		//试验类型
		var testType = Ext.create('ExtApp.store.qualityissuemanagement.TestTypeStore');
		testType.load();
		
		//样车阶段
		var buildPhase = Ext.create('ExtApp.store.qualityissuemanagement.BuildPhaseStore');
		buildPhase.load();
		
		this.items = [{
			xtype:'grid',
			store: store,
			selModel: 'checkboxmodel',
			columns: [{
				xtype : "rownumberer"
			},{
				text: '新提醒',
				width: 60,
				dataIndex: 'isNew',
				renderer: 'isNew',
				align: 'center'
			},{
				text: '风险',
				itemId: 'ItemRiskLevel',
				width: 60,
				dataIndex: 'riskLevelCode',
				renderer: 'renderRiskStatus',
				align: 'center'
			},{
				text: '问题编号',
				itemId: 'ItemCode',
				flex:1,
				dataIndex: 'code'
			},{
				text: '问题标题',
				itemId: 'ItemTitle',
				flex:1,
				dataIndex: 'title',
				renderer:function(value, metaData, record){
					 if(record.get('isReturn') == 'Y'){
						 return"<div style ='color:red'>"+value+"</div>";
					 }else{
						 return value;
					 }
				}
			},{
				text: '状态',
				itemId: 'ItemStatus',
				width: 60,
				dataIndex: 'issueProcessingStatus'
			},{
				text: '等级',
				itemId: 'ItemLevel',
				width: 60,
				dataIndex: 'issueLevelName'
			},{
				text: '所属项目',
				itemId: 'ItemProject',
				flex:1,
				dataIndex: 'programCode'
			},{
				text: '责任部门',
				itemId: 'ItemDepartment',
				flex:1,
				dataIndex: 'obsName'
			},{
				text: '当前任务名称',
				itemId: 'ItemTaskName',
				flex:1,
				dataIndex: 'taskName'
			},{
				text: '当前任务负责人',
				itemId: 'ItemTaskOwner',
				flex:1,
				dataIndex: 'taskOwnerName'
			},{
				text: '等待时间（天）',
				itemId: 'ItemWaitDays',
				width: 120,
				dataIndex: 'daysElapsed',
				filter: {
					type: 'number'
				}
			},{
				text: '挂牌时间',
				itemId: 'ItemListingDate',
				width: 100,
				dataIndex: 'listingDate',
				formatter: 'date("Y/m/d")',
				filter: {
					type: 'date'
				}
			},{
				text: '摘牌时间',
				itemId: 'ItemDelistDate',
				width: 100,
				dataIndex: 'delistDate',
				formatter: 'date("Y/m/d")',
				filter: {
					type: 'date'
				}
			},{
				text: '最近访问时间',
				itemId: 'ItemLastAccessDate',
				hidden:true,
				width: 100,
				dataIndex: 'lastAccessDate',
				formatter: 'date("Y/m/d")',
				filter: {
					type: 'date'
				}
			},{
				xtype: 'actioncolumn',
		        width: 30,
		        sortable: false,
		        menuDisabled: true,
		        items: [{
		            iconCls: 'cell-editing-delete-row',
		            handler: 'deleteRow'
		        }]	
			}],
			tbar: [{
				xtype: 'form',
		    	margin: 2,
		    	layout:{
					type:'vbox',
					align:'stretch'
				},
				width: '100%',
				items: [{
					xtype: 'fieldset',
					flex:1,
			    	title: '<B>高级查询</B>',
			    	titleAlign: 'right',
			    	collapsible:true,
			    	collapsed: true,
			    	margin: 2,
			    	layout: 'fit',
			    	items: [{
			    		xtype: 'panel',
			    		layout: 'column',
			    		defaults: {
			    			labelAlign: 'right',
			    			margin: 5
			    		},
						items: [{
							xtype:'combo',
							fieldLabel:'所属项目',
							editable: false,
							store: program,
							queryMode:'local',
							displayField:'name',
							valueField:'id',
							listeners: {
								change: function(combo, newValue, oldValue, eOpts) {
							    	programVehicleStore.load({params:{programId: newValue}});
							    }
							},
							columnWidth: 0.25,
							name:'searchProgramCode'
						},{
							xtype : 'combo',
							fieldLabel:'子项目',
							editable: false,
							queryMode:'local',
							displayField:'name',
							valueField:'id',
							store:programVehicleStore,
							columnWidth: 0.25,
							name:'searchSubProjectCode',
							listeners:{
								change:function(combo, newValue, oldValue, eOpts){
									resDepartmentStore.load({params:{keyId:newValue,queryFlg:1}});
								}
							}
						},{
							xtype:'combo',
							fieldLabel:'责任部门',
							editable:false,
							queryMode:'local',
							displayField:'name',
							valueField:'id',
							columnWidth: 0.25,
							name:'searchObsName',
							store:resDepartmentStore
						},{
							xtype : 'combo',
							fieldLabel:'样车阶段',
							columnWidth: 0.25,
							store: buildPhase,
						    queryMode: 'local',
						    displayField: 'name',
						    valueField: 'id',
							name:'searchSampleNumber',
						    forceSelection: true
						},{
							xtype: 'textfield',
							name: 'searchTroublePartCode',
							columnWidth: 0.25,
							fieldLabel: '故障零件编号'
						},{
							xtype: 'textfield',
							name: 'searchTroublePartName',
							columnWidth: 0.25,
							fieldLabel: '故障零件名称'
						},{
							xtype: 'textfield',
							name: 'searchTaskName',
							columnWidth: 0.25,
							fieldLabel: '当前任务名称'
						},{
							xtype: 'textfield',
							name: 'searchTaskOwner',
							columnWidth: 0.25,
							fieldLabel: '当前任务负责人'
						},{
							xtype: 'textfield',
							name: 'searchCode',
							columnWidth: 0.25,
							fieldLabel: '问题编号'
						},{
							xtype: 'textfield',
							name: 'searchTitleIn',
							columnWidth: 0.25,
							fieldLabel: '问题标题'
						},{
							xtype: 'combobox',
							name: 'searchIssueLevel',
							columnWidth:0.25,
							fieldLabel: '问题等级',
							store: levelStore,
						    queryMode: 'local',
						    displayField: 'name',
						    valueField: 'code',
						    forceSelection: true
						},{
							xtype: 'combobox',
							name: 'searchRiskLevelCode',
							columnWidth:0.25,
							fieldLabel: '风险等级',
							store: riskStore,
						    queryMode: 'local',
						    displayField: 'name',
						    valueField: 'code',
						    forceSelection: true
						},{
							xtype: 'combobox',
							name: 'searchIssueSourceId',
							columnWidth:0.25,
							fieldLabel: '问题来源',
							store: problemSource,
						    queryMode: 'local',
						    displayField: 'name',
						    valueField: 'id',
						    forceSelection: true
						},{
							xtype: 'combobox',
							name: 'searchIssueTypeId',
							columnWidth:0.25,
							fieldLabel: '问题类型',
							store: issueTypeStore,
						    queryMode: 'local',
						    displayField: 'name',
						    valueField: 'id',
						    forceSelection: true
						},{
							xtype: 'combobox',
							name: 'searchTestTypeId',
							columnWidth:0.25,
							fieldLabel: '试验类型',
							store: testType,
						    queryMode: 'local',
						    displayField: 'name',
						    valueField: 'id',
						    forceSelection: true
						},{
							xtype: 'combobox',
							name: 'searchIssueStatus',
							columnWidth:0.25,
							fieldLabel: '问题状态',
							store: statusStore,
							multiSelect:true,
						    queryMode: 'local',
						    displayField: 'name',
						    valueField: 'code',
						    forceSelection: true
						},{
							xtype: 'combobox',
							name: 'searchIssueNatureId',
							columnWidth:0.25,
							fieldLabel: '问题性质',
							store: issueNatureStore,
						    queryMode: 'local',
						    displayField: 'name',
						    valueField: 'id',
						    forceSelection: true
						},{
							xtype: 'datefield',
							format: 'Y/m/d',
							name: 'searchCreateDateFrom',
							columnWidth: 0.25,
							fieldLabel: '提出时间'
						},{
							xtype: 'datefield',
							format: 'Y/m/d',
							name: 'searchCreateDateTo',
							columnWidth: 0.25,
							fieldLabel: 'To'
						},{
							xtype: 'datefield',
							format: 'Y/m/d',
							name: 'searchListingDate',
							columnWidth: 0.25,
							fieldLabel: '挂牌时间'
						},{
							xtype: 'datefield',
							format: 'Y/m/d',
							name: 'searchExpectedDateFrom',
							columnWidth: 0.25,
							fieldLabel: '计划对策时间'
						},{
							xtype: 'datefield',
							format: 'Y/m/d',
							name: 'searchExpectedDateTo',
							columnWidth: 0.25,
							fieldLabel: 'To'
						},{
							xtype: 'datefield',
							format: 'Y/m/d',
							name: 'searchPlanClosedDateFrom',
							columnWidth: 0.25,
							fieldLabel: '计划关闭时间'
						},{
							xtype: 'datefield',
							format: 'Y/m/d',
							name: 'searchPlanClosedDateTo',
							columnWidth: 0.25,
							fieldLabel: 'To'
						},{
							xtype: 'radiogroup',
					        fieldLabel: '是否挂牌',
					        vertical: true,
					        name:'isListing',
					        columnWidth: 0.25,
					        items: [
					            { boxLabel: '是', name: 'isListing', inputValue: 'Y'},
					            { boxLabel: '否', name: 'isListing', inputValue: 'N' }
					        ]
						},{
							xtype: 'radiogroup',
					        fieldLabel: '是否合并',
					        vertical: true,
					        name:'isMerge',
					        columnWidth: 0.25,
					        items: [
					            { boxLabel: '是', name: 'isMerge', inputValue: 'Y'},
					            { boxLabel: '否', name: 'isMerge', inputValue: 'N' }
					        ]
						}]
			    	}]
				},{
					xtype: 'panel',
					margin: '10 2 2 2',
		    		layout:{
						type:'hbox',
						align:'stretch'
					},
			    	items: [{
			    		xtype: 'textfield',
						name: 'searchTitle',
						fieldLabel: '问题标题'
			    	},{
						xtype:'checkbox',
						name:'searchProcessing',
						checked: true,
						margin: '0 0 0 10',
						labelWidth: 40,
						labelSeparator: '',
						fieldLabel:'进行中'
					},{
						xtype:'checkbox',
						name:'searchClosed',
						checked: true,
						margin: '0 0 0 10',
						labelWidth: 40,
						labelSeparator: '',
						fieldLabel:'已关闭'
					},{
						xtype:'checkbox',
						name:'searchArchived',
						checked: true,
						margin: '0 0 0 10',
						labelWidth: 40,
						labelSeparator: '',
						fieldLabel:'已归档'
					},{
						xtype: 'button',
						margin: '0 0 0 20',
						text: '查询',
						iconCls: 'x-fa fa-search',
						handler: 'search'
					},{
						xtype: 'button',
						margin: '0 0 0 5',
						text: '重置',
						iconCls: 'x-fa fa-rotate-left',
						handler: 'reloadSearch'
//					},{
//						xtype: 'tbfill'
					},{
						xtype:'button',
						itemId: 'btnSetRiskLevel',
						margin: '0 0 0 5',
						text:'风险等级',
						handler:'setRiskLevel'
					},{
						xtype: 'button',
						margin: '0 0 0 5',
						text: '导出',
						iconCls: 'x-fa fa-file-excel-o',
						handler: 'exportIssueList'
			    	},{
						text: '移交',
						xtype: 'button',
						margin: '0 0 0 5',
						itemId: 'transferTask',
						iconCls: 'fa fa-share',
						hidden:true,
						handler: 'transferTask'
					}]
				}]
			}],
            dockedItems: [{
                xtype: 'pagingtoolbar',
                dock: 'bottom',
                displayInfo: true,
                store: store
            }],
            listeners:{
            	celldblclick: 'onCelldblclick'
			}
		}];
		this.callParent(arguments);
	}
});