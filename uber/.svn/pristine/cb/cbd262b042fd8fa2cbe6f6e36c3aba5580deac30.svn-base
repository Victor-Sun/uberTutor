/**
 * 项目管理-项目计划基线详细
 */
Ext.define('ExtApp.view.projectmanagement.baseline.baselineWindowController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.baselineWindow',
    
    // 初始化
    init: function() {
    	var me = this;
		// 权限控制
    	var setBaselinePrivilege = false;
    	if (me.view.obsId && me.view.obsId != '' && me.view.obsId != null) {
    		setBaselinePrivilege = ExtApp.util.Util.getPrivilege(
        			'P0909', this.view.projectPrivilege, this.view.programVehicleId);
    	} else {
    		setBaselinePrivilege = ExtApp.util.Util.getPrivilege(
        			'P1009', this.view.projectPrivilege, this.view.programVehicleId);
    	}
    	// 项目状态取得
    	var statusStore = Ext.create(
			'ExtApp.store.projectmanagement.ProjectPlanStatusStore');
		statusStore.getProxy().extraParams = {
			programVehicleId: me.view.programVehicleId,
			obsId: me.view.obsId};
		statusStore.load();
		statusStore.on('load', function() {
			var planStatus = this.data.getAt(0).get('planStatus');
			if (setBaselinePrivilege &&
					me.view.isActive == 'Y' &&
					planStatus == 'INACTIVE') {
				me.view.header.getComponent('BTNCopyPlan').show();
	    	}
		});
    },

	// Tree节点点击
	onItemClick: function(view, record, item, index, e, eOpts) {
        var viewType = record.get('viewType');
        if (! viewType) {
        	return;
        }
        this.showView(viewType, record);
	},

	// 点击节点
    showView: function(view, record) {
    	var me = this;
		var refs = this.getReferences();
        var mainCard = refs.mainCardPanel;
        var lastView = mainCard.getLayout().getActiveItem();
        if (lastView != null) {
        	lastView.destroy();
        }

        var newView = Ext.create({
        	xtype: view,
        	baselineId: me.view.baselineId,
        	baselineObsId: me.view.obsId,
        	programId: me.view.programId,
        	programVehicleId: me.view.programVehicleId,
        	projectPrivilege: me.view.privilegeStore.data.getAt(0).data,
        	record: record
        });
        
        mainCard.add(newView);
        Ext.suspendLayouts();
        mainCard.getLayout().setActiveItem(newView);
        Ext.resumeLayouts(true);
	},

    // 复制为当前计划
    setBaseline: function() {
    	var me = this;
    	Ext.getBody().mask('Please Waiting...');
    	Ext.Ajax.request({
    	    url: '/pdms/pm/baseline!setDefaultBaseline.action',
    	 	params: {
    	 		programVehicleId: me.view.programVehicleId,
    	 		obsId: me.view.obsId,
    	 		baselineId: me.view.baselineId
    	 	},
    	 	scope: me,
    	 	success: function(response, opts) {
    	        Ext.getBody().unmask();
    	    	var obj = Ext.decode(response.responseText);
    	        if (obj.success) {
    	        	ExtApp.util.Util.showToast("复制成功！");
    	        	// 刷新父页面
    	        	me.view.parentCaller.view.parentCaller.refreshView();
    	        	// 关闭父页面
    	        	me.view.parentCaller.closeWindow();
    	        	// 关闭页面
    	        	me.closeWindow();
    	        } else {
    	        	ExtApp.util.Util.handleRequestFailure(response);
    	        }
    	 	},
 		    failure: function(response, opts) {
 		    	Ext.getBody().unmask();
 		    	ExtApp.util.Util.handleRequestFailure(response);
 		    }
        });
    },

    // 关闭
    closeWindow: function() {
    	this.view.close();
    }

});
