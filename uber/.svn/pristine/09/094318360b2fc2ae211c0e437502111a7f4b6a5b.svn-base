/**
 * 项目计划-专业领域/专业组计划-泳道信息
 */
Ext.define('ExtApp.view.projectManagement.deptplan.DeptPlanFunctionController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.deptPlanFunction',

    // 初始化
    init: function() {
    	var me = this;
    	
    	if (! me.view.editPrivilege) {
			me.view.down('toolbar').setHidden(true);
		}
    },
    
    // 点击菜单动作
    onItemclick: function(view, record, item, index, e, eOpts) {
    	var me = this;
		var refs = this.getReferences();
        var mainCard = me.view.up('deptPlanBase').query('#mainCardPanel')[0];
        var lastView = mainCard.getLayout().getActiveItem();
        if (lastView != null) {
        	lastView.destroy();
        }

        var newView = Ext.create({
        	xtype: 'deptPlanTask',
        	programId: me.view.programId,
        	programVehicleId: me.view.programVehicleId,
        	obsId: me.view.record.get('fnGroupId'),
        	functionId: record.get('id'),
        	respObsId: record.get('respObsId'),
        	planLevel: me.view.record.get('planLevel'),
        	fnPlanLevel: record.get('fnPlanLevel'),
        	editPrivilege: me.view.editPrivilege && (me.view.record.get('planLevel') == record.get('fnPlanLevel')),
        	baselineId: me.view.baselineId
        });

        mainCard.add(newView);
        Ext.suspendLayouts();
        mainCard.getLayout().setActiveItem(newView);
        Ext.resumeLayouts(true);
	},
	
	// 添加泳道
	addFunction: function() {
		var me = this;
		Ext.create({
    		xtype: 'createFunction',
    		programId: me.view.programId,
        	programVehicleId: me.view.programVehicleId,
        	planLevel: me.view.record.get('planLevel'),
        	planId: me.view.record.get('planId'),
        	obsId: me.view.record.get('fnGroupId'),
        	actionType: 'new',
            parentCaller: me
        }).show();
	},
	
	// 右键菜单
	onItemcontextmenu: function(tree, record, item, index, e, eOpts) {
		var me = this;
		e.preventDefault();  
        e.stopEvent();
        // 无编辑权限、或者二级计划中不允许编辑主计划泳道
        if (! me.view.editPrivilege ||
        		record.get('fnPlanLevel') != me.view.record.get('planLevel')) {
        	return;
        }
        var menu = new Ext.menu.Menu({
			items: [{
				text: '修改泳道',
				listeners: {
					click: function() {
						me.updateFunction(record);
					}
				}
			},{
				text: '删除泳道',
				listeners: {
					click: function() {
						me.deleteFunction(record);
					}
				}
			}]
		});
    	menu.showAt(e.getXY());
	},
	
	// 删除泳道
	deleteFunction: function(record) {
		var me = this;
    	Ext.MessageBox.confirm('提示', '删除该条记录只删除时程表的显示信息，不会删除任务，确认删除？', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    			me.view.mask('Please Waiting...');
    	    	Ext.Ajax.request({
    	    		url:'/pdms/pm/dept-plan!deleteFunction.action',
    	    		params: {
    	    			functionId: record.get('id')
    				},
    				scope: me,
    				success: function(response, opts) {
    					me.view.unmask();
    			    	var obj = Ext.decode(response.responseText);
        		    	if (obj.success) {
        		    		me.refreshView();
        		    		// 清空右侧面板
        		    		var mainCard = me.view.up('deptPlanBase').query('#mainCardPanel')[0];
        		            var lastView = mainCard.getLayout().getActiveItem();
        		            if (lastView != null) {
        		            	lastView.destroy();
        		            }
        			    	ExtApp.util.Util.showToast("删除成功！");
        		        } else {
        		        	ExtApp.util.Util.handleRequestFailure(response);
        		        }
    			    },
    				failure: function(response, opts) {
    					me.view.unmask();
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	});
    		}
    	});
	},
	
	// 修改泳道
	updateFunction: function(record) {
		var me = this;
		Ext.create({
    		xtype: 'createFunction',
    		programId: me.view.programId,
        	programVehicleId: me.view.programVehicleId,
        	functionId: record.get('id'),
        	planLevel: me.view.record.get('planLevel'),
        	planId: me.view.record.get('planId'),
        	obsId: me.view.record.get('fnGroupId'),
        	actionType: 'update',
            parentCaller: me
        }).show();
	},
	
	// 移动
	onDrop: function(node, data, overModel, dropPosition, eOpts) {
		var me = this;
		
        // 无编辑权限、或者二级计划中不允许移动主计划泳道
        if (! me.view.editPrivilege ||
        		data.records[0].get('fnPlanLevel') != me.view.record.get('planLevel')) {
        	ExtApp.util.Util.showErrorMsg('不允许移动该泳道!');
        	me.refreshView();
        	return;
        }
        
        // 不允许移动二级计划泳道到主计划以上
        if (overModel.get('fnPlanLevel') != me.view.record.get('planLevel')) {
        	ExtApp.util.Util.showErrorMsg('不允许移动二级计划泳道到主计划以上!');
        	me.refreshView();
        	return;
        }
        
		me.view.mask('Please Waiting...');
    	Ext.Ajax.request({
    		url:'/pdms/pm/dept-plan!resequenceFunction.action',
    		params: {
    			programVehicleId: me.view.programVehicleId,
    			planId: me.view.record.get('planId'),
    			functionId: data.records[0].get('id'),
    			overSeqNo: overModel.get('seqNo'),
    			dropPosition: dropPosition
			},
			scope: me,
			success: function(response, opts) {
				me.view.unmask();
		    	var obj = Ext.decode(response.responseText);
		    	if (obj.success) {
		    		me.refreshView();
		        } else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
		    },
			failure: function(response, opts) {
				me.view.unmask();
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
    	});
	},
	
	refreshView: function() {
		this.view.down('treepanel').store.reload();
	}
});