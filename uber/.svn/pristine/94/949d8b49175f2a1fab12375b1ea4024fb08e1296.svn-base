/**
 * 质量问题管理-我的待办-分配方案2Controller
 */
Ext.define('ExtApp.view.qualityissuemanagement.qedashboard.step10.MyTaskInfo10Controller', {
    extend: 'ExtApp.view.common.IssueStepViewController',
    alias: 'controller.myTaskInfo10',
    
    target: null,

    //初期加载
    init: function() {
    	var me = this;
    	var form = this.lookupReference('refVerificationScheme11');
    	form.load({
            url:'/pdms/ims/my-task!getVerificationLineForm.action',
			params: {
				keyId: this.view.keyId,
	    		formKey: this.view.formKey,
	    		taskId: this.view.taskId,
	    		vid:me.view.record.get('vid')
			},
			//添加验证方案
            success: function(form,result,data) {
    			Ext.each(result.result.data, function (record) {
    				me.addPanel(record);
    			});
            }
        });
    },
	//加载验证方案MyTaskInfo11
    addPanel: function (record) {
    	var refPanel = this.lookupReference('refVerificationScheme11');
		var fieldlabelIndex = refPanel.items.length + 1;
//		var seq = record.seq;
//		var engineersStore = Ext.create(
//			'ExtApp.store.qualityissuemanagement.EngineersStore');
//		engineersStore.getProxy().extraParams = {
//			keyId: m_form.keyId,
//			programObsId: record.programObsId,
//			programVehicleId: m_form.programVehicleId
//			};
//		engineersStore.load();
		var configItem=[{
			xtype:'fieldset',
			title:'<B>验证方案 '+ fieldlabelIndex+'</B>',
			collapsible: true,
			scrollable: true,
			layout:{
				type:'vbox'
			},
			defaults: {
				layout: 'hbox',
				defaults: {
					margin: 5
				}
			},
			items:[{
				xtype:'container',
				items:[{
					xtype:'combo',
					fieldLabel:'验证方案' + fieldlabelIndex,
					readOnly:true,
					editable:false,
					bind:{
						store:'{verification}'
					},
					queryMode:'local',
					displayField:'name',
					valueField:'id',
					name:'verification',
					value:record.verification
				},{
					xtype:'textareafield',
					fieldLabel:'通过要求',
					readOnly:true,
					width: 560,
					name:'passRequest',
					value:record.passRequest
				}]
			},{
				xtype: 'container',
				items: [{
					xtype:'textareafield',
					fieldLabel:'实施信息',
					width: 845,
					readOnly:true,
					name:'implementVehicle',
					value:record.implementVehicle
				},{
					xtype:'textfield',
					hidden:true,
					readOnly:true,
					name:'uid',
					value:record.uid
				}]
			},{
				xtype:'container',
				items:[{
					xtype:'textfield',
					fieldLabel:'验证部门',
					readOnly:true,
					name:'deptName',
					value:record.deptName
				},{
					xtype:'textfield',
					itemId:'engineerIndex' + fieldlabelIndex,
					fieldLabel:'验证工程师 &nbsp;<span style="color: red;">*</span>',
					readOnly:true,
					emptyText: '<单击选择人员>',
					editable:false,
					allowBlank:false,
					name:'verificationEngineerName',
					listeners:{
						click: {
				            element: 'el',
				            fn: 'selectMember'
				        }
					},
					value:record.verificationEngineerName
				},{
					xtype:'textfield',
					hidden:true,
					readOnly:true,
					name:'verificationEngineer',
					value:record.verificationEngineer
				}]
			}]
		}];
		refPanel.add(configItem[0]);
    },
    // 点击【提交】
    distribution : function(btn) {
    	var me = this;
    	var v_form = me.view.getForm();
    	if(v_form.isValid() == false){
    		Ext.Msg.alert('提示', "请填写必填项！！！");
    		return;
    	}
    	v_form.submit({
    		url: '/pdms/ims/my-task-info11!saveMyTask.action',
    	    waitMsg : '正在提交数据',  
    	    waitTitle : '提示',  
    	    method : "POST",
    	    success : function(form, action) {  
    	    	var gridTask = me.getView().grid.getStore().load();
    	    	me.getView().close();
    	    },  
    	    failure : function(form, action) {
    	    	ExtApp.util.Util.handleFormFailure(action);
    	    }
    	});
    },
    //审核&&批准
    selectMember: function(v) {
    	var me = this.view;
    	this.target = v.getTarget().name;

    	this.dialog = me.add({
    		xtype: 'sysUserDepartment',
    		parentCaller: this
    	});
        this.dialog.show();
    },
    // 添加用户/选择专业经理 - 确定
    confirmUser: function(userData) {

    	var me = this;
    	var v_form = me.view.getForm();
    	var Target = this.target;
    	//责任工程师
    	var verificationEngineerName = v_form.findField('verificationEngineerName');
    	//责任工程师ID
    	var verificationEngineer = v_form.findField('verificationEngineer');
    	
    	if(Target == "verificationEngineerName"){
    		verificationEngineerName.setValue(userData.name);
    		verificationEngineer.setValue(userData.id);
		}
    }
}); 