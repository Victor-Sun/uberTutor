/**
 * 项目管理-Open Issue（根）View
 */
Ext.define('ExtApp.view.projectManagement.issue.ProjectOpenIssue',{
	extend:'Ext.panel.Panel',
	xtype:'projectOpenIssue',

	controller: 'projectOpenIssue',
	viewModel: 'projectOpenIssue',
	layout:{
		type:'vbox',
		align:'stretch'
	},
	initComponent: function() {
		var openIssueStore = Ext.create('ExtApp.store.projectmanagement.ProjectOpenIssueStore');
		openIssueStore.getProxy().extraParams = {programId: this.programId};
		openIssueStore.load();
		var issueStatisticForm = Ext.create('ExtApp.view.projectManagement.issue.IssueStatisticForm');
		issueStatisticForm.load({params:{programId:this.programId}});
		
		var projectOpenIssueLineChart = Ext.create('ExtApp.view.projectManagement.issue.ProjectOpenIssueLineChart',{programId: this.programId});
		var projectOpenIssueBarChart = Ext.create('ExtApp.view.projectManagement.issue.ProjectOpenIssueBarChart',{programId: this.programId});
		var projectOpenIssuePieChart = Ext.create('ExtApp.view.projectManagement.issue.ProjectOpenIssuePieChart',{programId: this.programId});
		this.items = [{
			xtype: 'tabpanel',
			layout:'fit',
			items: [{
				xtype:'panel',
				layout:{
					type:'vbox',
					align:'stretch'
				},
				title: 'Open Issue',
				items:[issueStatisticForm,{
					xtype:'grid',
					height:Ext.getBody().getViewSize().height-170,
					store: openIssueStore,
					columns:[{
						xtype: 'rownumberer'
					},{
						text: '新提醒',
						width: 60,
						dataIndex: 'isNew',
						renderer: 'isNew',
						align: 'center'
					},{
						text:'进度状态',
						width: 80,
						dataIndex:'progressStatus',
						renderer: 'renderIssueProgress',
						align: 'center'
					},{
						text:'问题标题',
						width:120,
						dataIndex:'issueTitle'
					},{
						text:'问题来源',
						width:120,
						dataIndex:'issueSourceTitle'
					},{
						text:'提出人',
						width: 100,
						dataIndex:'raiseByName'
					},{
						text:'提出日期',
						width: 100,
						dataIndex:'raiseDate'
					},{
						text:'所属项目',
						width: 150,
						dataIndex:'programCode'
					},{
						text:'所属车型',
						width: 150,
						dataIndex:'vehicleCode'
					},{
						text:'责任组',
						width: 120,
						dataIndex:'respObsName'
					},{
						text:'责任人',
						width: 100,
						dataIndex:'respUserName'
					},{
						text:'当前任务负责人',
						width: 130,
						dataIndex:'taskOwner'
					},{
						text:'完成状态',
						width: 80,
						dataIndex:'statusCodeName'
					},{
						text:'计划完成日期',
						width: 120,
						dataIndex:'dueDate'
					},{
						text:'实际完成日期',
						width: 120,
						dataIndex:'actualFinishDate'
					},{
						text:'计划偏离天数',
						dataIndex:'daysDelayed',
						width:150
					},{
						text:'优先级',
						dataIndex:'issuePriorityName', 
						width: 100
			        },
					{ xtype:'actioncolumn',
			            width:50,
			            items: [{
			            	iconCls:'x-fa fa-trash',
			                tooltip: 'Delete',
			                handler: function(grid, rowIndex, colIndex) {
			                	 var rec = grid.getStore().getAt(rowIndex);
			                	 var id = rec.get('id');
			                	 Ext.Ajax.request({
			                		 url: '/pdms/pm/project-open-issue!deleteOpenIssue.action',
			                		 params:{id:id},
			                	     success: function(response, opts) {
			                	    	 var result = ExtApp.util.Util.decodeJSON(response.responseText);
			                	 		 if (!result){ //#4
			            	    	 		 result = {};
			            	    	 		 result.success = false;
			            	    	 		 result.msg = response.responseText;
			                	 		 }
			                	 		 openIssueStore.load();
			                	     },

			                	     failure: function(response, opts) {
			                	    	 var result = ExtApp.util.Util.decodeJSON(response.responseText);
			                	 		 
			                	     }
			                	 });
			                },
			                getClass: function(v, meta, rec) {
			                	var status = rec.get('status');
			                    if (status == 'RESUBMIT' || status == 'DRAFT' || status == ''  || status == null) {
			                          return 'x-fa fa-trash';
			                    }else{
			                    	return 'x-hidden';
			                    }
			            	}
			            }]
			        }],
					listeners:{
			        	celldblclick: 'onCelldblclick'
					},
					tbar: [{
			            text: '提出问题',
			            handler: 'raiseIssue'
			        },{
			            text: '导出Excel',
			            handler: 'exportExcel'
			        }],
					dockedItems: [{
						xtype: 'pagingtoolbar',
						dock: 'bottom',
						displayInfo: true,
						store: openIssueStore
					}]
				}]
			},projectOpenIssueLineChart,projectOpenIssueBarChart,projectOpenIssuePieChart]
		}];
		this.callParent(arguments);
	}
});