Ext.define('ExtApp.view.myworkspace.task.PmTask',{
	extend:'Ext.panel.Panel',
	xtype:'pmTask',

	layout:{
		type:'hbox',
		align:'stretch'
	},
	
	closable: true,
	
	controller: 'pmTask',
	
	initComponent: function() {
		// 画面区分取得
		this.viewFlag = '';
		// 参照
		if (this.readonlyFlag) {
			this.viewFlag = 'view';
		} else {
	        // 已完成任务
			if (this.completeFlag == 'Y') {
				this.viewFlag = 'view';
			} else {
				// 执行
				if (this.processStepId == 1) {
					this.viewFlag = 'performance';
		    	// 审批
				} else {
					this.viewFlag = 'approve';
				}
			}
		}
		
		// 基本信息
		var general = Ext.create('ExtApp.view.myworkspace.task.PmTaskGeneral');
		general.load({
			url: '/pdms/mw/todo-list!getTodoTaskInfo.action',
			params: {
				processTaskId: this.processTaskId
			}
		});

		// 批示
		var comment = Ext.create(
				'ExtApp.view.myworkspace.task.PmTaskComment',
				{taskId: this.taskId, processId: this.processId}
		);
		
		// 交付物状态
		var progressStore = Ext.create(
			'ExtApp.store.common.CodeTableStore');
		progressStore.getProxy().extraParams = {
			type: 'TASK_PROGRESS_STATUS',
			exceptCode: 'TASK_PROGRESS_STATUS_GREY'};
		progressStore.load();
		
		this.items = [{
			xtype:'panel',
			flex:1,
			layout:{
				type:'vbox',
				align:'stretch'
			},
			items:[{
				xtype:'panel',
				title:'基本信息',
				collapsible: true,
				height:260,
				layout:'fit',
				items:[general]
			},{
				xtype:'pmTaskDetail',
				flex:1,
				defaults:{
					scrollable:'y'
				},
				programId: this.programId,
				taskId: this.taskId,
				processTaskId: this.processTaskId,
				processId: this.processId,
				taskStatusCode: this.taskStatusCode,
				viewFlag: this.viewFlag
			}]
		},{
			xtype:'panel',
			width:325,
			title:'审批记录',
			layout:'fit',
			border:true,
			collapsible:true,
			collapseDirection:'right',
			collapseMode:'header',
			defaults:{
				scrollable:'y'
			},
			items:[comment]
		}];
	
		this.tbar = [{
			xtype:'displayfield',
			fieldLabel:'风险状态',
			labelSeparator: '',
			labelWidth: 60
		},{
			xtype:'image',
			itemId: 'progressStatus',
			src:'resources/images/' + this.controller.getProgressImage(this.taskProgressStatusCode),
			width: 20
		},'-',{
			xtype:'displayfield',
			itemId: 'dispDeliverableStatus',
			fieldLabel:'申请变更的风险状态',
			labelSeparator: '',
			labelWidth: 120
		},{
			xtype:'image',
			itemId: 'deliverableStatus',
			src:'resources/images/' + this.controller.getProgressImage(this.processTaskProgressStatus),
			width: 20
		},{
			xtype: 'combobox',
			itemId: 'comDeliverableStatus',
	    	editable: false,
			store: progressStore,
		    queryMode: 'local',
		    displayField: 'name',
		    valueField: 'code',
		    value: this.processTaskProgressStatus,
		    forceSelection: true,
			listeners:{
				change: 'changeDeliverableStatus'
			}
		},'-',{
			text: '延期变更',
			itemId: 'btnApply',
			align: 'center',
			handler: 'extensionTask'
		},{
			text: '汇报进度',
			itemId: 'btnReport',
			align: 'center',
			handler: 'reportProgress'
		},{
			text: '审批通过',
			itemId: 'btnApprove',
			align: 'center',
			handler: 'approve'
		},{
			text: '审批不通过',
			itemId: 'btnReject',
			align: 'center',
			handler: 'reject'
		}];
		this.callParent(arguments);
	}
});