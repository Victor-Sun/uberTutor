/**
 * 首页-个人设置-我的工作组
 */
Ext.define('ExtApp.view.toolbarsettings.MyWorkGroupController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.myWorkGroup',
    
    // 单击工作组列表
    onCellclickGroup: function(grid, td, cellIndex, record, tr, rowIndex, e, eOpts) {
    	var me = this;
    	var mainCard = me.view.query('#mainCardPanel')[0];
        var lastView = mainCard.getLayout().getActiveItem();
        if (lastView != null) {
        	lastView.destroy();
        }

        var newView = Ext.create({
        	xtype: 'myWorkGroupMember',
        	workGroupId: record.get('id')
        });

        mainCard.add(newView);
        Ext.suspendLayouts();
        mainCard.getLayout().setActiveItem(newView);
        Ext.resumeLayouts(true);
    },
    
    // 右键工作组列表
    onCellcontextmenuGroup: function(grid, td, cellIndex, record, tr, rowIndex, e, eOpts) {
    	var me = this;
		e.preventDefault();  
        e.stopEvent();

        var menu = new Ext.menu.Menu({
			items: [{
				text: '重命名',
				listeners: {
					click: function() {
						me.updateGroup(record);
					}
				}
			},{
				text: '删除',
				listeners: {
					click: function() {
						me.deleteGroup(record);
					}
				}
			}]
		});
    	menu.showAt(e.getXY());
    },
    
    // 添加工作组
    onAddGroup: function() {
    	var me = this;
		Ext.create({
    		xtype: 'createWorkGroup',
        	actionType: 'new',
            parentCaller: me
        }).show();
    },
    
    // 重命名
    updateGroup: function(record) {
    	var me = this;
		Ext.create({
    		xtype: 'createWorkGroup',
    		workGroupId: record.get('id'),
    		groupName: record.get('name'),
        	actionType: 'update',
            parentCaller: me
        }).show();
    },
    
    // 删除工作组
    deleteGroup: function(record) {
    	var me = this;
    	Ext.MessageBox.confirm('提示', '确定要删除该条记录？', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    			me.view.mask('Please Waiting...');
    	    	Ext.Ajax.request({
    	    		url:'/pdms/ts/personal-settings!deleteMyWorkGroup.action',
    	    		params: {
    	    			workGroupId: record.get('id')
    				},
    				scope: me,
    				success: function(response, opts) {
    					me.view.unmask();
    			    	var obj = Ext.decode(response.responseText);
        		    	if (obj.success) {
        		    		me.refreshView();
        		    		// 清空右侧面板
        		    		var mainCard = me.view.query('#mainCardPanel')[0];
        		            var lastView = mainCard.getLayout().getActiveItem();
        		            if (lastView != null) {
        		            	lastView.destroy();
        		            }
        			    	ExtApp.util.Util.showToast("删除成功！");
        		        } else {
        		        	ExtApp.util.Util.handleRequestFailure(response);
        		        }
    			    },
    				failure: function(response, opts) {
    					me.view.unmask();
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	});
    		}
    	});
    },
    
    // 刷新
    refreshView: function() {
    	this.lookupReference('refGroupGrid').store.reload();
    }
});
