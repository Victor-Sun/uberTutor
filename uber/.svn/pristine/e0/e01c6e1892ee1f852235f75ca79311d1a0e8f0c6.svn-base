Ext.define('ExtApp.view.projectManagement.issue.raiseissue.RaiseIssueWindowController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.raiseIssueWindow',
    onButtonClickSubmit: function(button, e, options){
        var me = this;
        var form = this.lookupReference('raiseIssueForm');
        var win = form.up('window');
//	    var grid = Ext.ComponentQuery.query('#da022Documents')[0];
//   	    var documentStore = grid.getStore();
        var flag = 'Y';
//      var submitedFlag = 'Y';
//        documentStore.each(function(record) {
//	      	if('Y' != record.get('completeFlag') && 'SR' == record.get('reqCode') ){
//	      		flag = 'N';
//	      		return false;
//	      	}
//	    });
        if(flag == 'N'){
        	Ext.Msg.alert('提示', '请上传所有必须的文档！');
        	return;
        }else{
            if (form.isValid()){
        		me.getView().mask('正在提交... 请耐心等待...');
                form.submit({
                	params:{action:'NEXT'},
                    clientValidation: true,
                    url: '/pdms/pm/project-open-issue!saveIssue.action',
                    scope: me,
                    success: 'onSubmitSuccess',
                    failure: 'onSubmitFailure'
                });
        	}
        }

    },
    onSubmitFailure: function(form, action) {

        this.getView().unmask();
        ExtApp.util.Util.handleFormFailure(action);
    },

    onSubmitSuccess: function(form, action) {
        var view = this.getView();
        view.unmask();
        var form = this.lookupReference('raiseIssueForm');
        var win = form.up('window');
        win.close();
        Ext.Msg.alert('提示', '提交成功！');
        var grid = win.grid;
        if(grid){
        	grid.getStore().load();
        }
    },
    
    onButtonClickSave: function(button, e, options){
        var me = this;
        var form = this.lookupReference('raiseIssueForm');
        var win = form.up('window');
//        var dddd = form.getForm().findField('appliedAmountTest').getValue();
//        alert(dddd);
//        return;
        if (form.isValid()){
            me.getView().mask('正在保存... 请耐心等待...');
            form.submit({
            	params:{action:'SAVE'},
                clientValidation: true,
                url: '/pdms/pm/project-open-issue!saveIssue.action',
                scope: me,
                success: 'onSaveSuccess',
                failure: 'onSubmitFailure'
            });
        }
    },
    
    onSaveSuccess: function(form, action) {
    	this.getView().unmask();
    	var result = ExtApp.util.Util.decodeJSON(action.response.responseText);
    	var form = this.lookupReference('raiseIssueForm');
    	form.getForm().findField('id').setValue(result.data.issueId);
    	this.getView().grid.getStore().load();
    },
    
    onUploadFileClick:function(){
    	 var me = this;
         //var form = Ext.ComponentQuery.query('#raiseIssueFormItemId')[0];
         //var win = form.up('window');
         //var id = form.getForm().findField('id').getValue();
    	 var id = me.view.issueId;
         if (! id || id == null || id == '') {
        	 var form = Ext.ComponentQuery.query('#raiseIssueFormItemId')[0];
//             if (form.isValid()){
             me.getView().mask('正在上传文档... 请耐心等待!');
             form.submit({
             	params:{action:'SAVE'},
                clientValidation: true,
                url: '/pdms/pm/project-open-issue!saveIssue.action',
                scope: me,
                success: 'onUploadFileSaveSuccess',
                failure: 'onSubmitFailure'
            });
//             }
         } else {
        	 me.uploadFile(id);
         }
    },
    onUploadFileSaveSuccess: function(form, action) {
    	var me = this;
    	this.getView().unmask();
    	var result = ExtApp.util.Util.decodeJSON(action.response.responseText);
    	var form = Ext.ComponentQuery.query('#raiseIssueFormItemId')[0];
    	form.getForm().findField('id').setValue(result.data.issueId);
    	me.uploadFile(result.data.issueId);
    },
    uploadFile:function(id){    	
    	var me = this;
    	me.id = id;
        var form = this.lookupReference('raiseIssueDocumentForm');
        if (form.isValid()){
            me.getView().mask('正在上传... 请耐心等待！...');
            form.submit({
                clientValidation: true,
                scope: me,
                params:{issueId:id},
                success: 'onUploadSuccess',
                failure: 'onSubmitFailure'
            });
        }
   },    
   onUploadSuccess: function(form, action) {
	   var me = this;
	   var view = this.getView();
       view.unmask();
//       var form = Ext.ComponentQuery.query('#da022FormItemId')[0];
//   	   var appId = form.getForm().findField('id').getValue();
//   	   var grid = Ext.ComponentQuery.query('#da022Documents')[0];
//   	   grid.getStore().load({params:{appId:appId,processCode:'DA022',type:'01'}});
//   	   var da022DocumentForm = this.lookupReference('da022DocumentForm');
//   	   var window = da022DocumentForm.up('da022DocumentWindow');
//   	   window.grid.up('da022DocumentsDetailWindow').appId = appId;
//   	   window.grid.getStore().load({params:{creditLineChecklistId:window.creditLineChecklistId,appId:appId}});
       var form = this.lookupReference('raiseIssueDocumentForm');
       view.grid.getStore().load({params:{issueId:me.id}});
       view.grid.issueId = me.id;
       form.up('window').close();
   },
   validateDealerInfo:function(appId,callback){
//		 me.getView().mask('正在验证，请稍后...');
		 Ext.Ajax.request({
      	 url: '/afc/dealerapp/dealerapp!validateDealerInfo.action',
      	 params:{id:appId},
			 success: function(response, opts) {
				 var result = ExtApp.util.Util.decodeJSON(response.responseText);
				 if(result.data == 'GRN'){//警告级别，GRN：绿灯；YEL：黄灯；RED：红灯。
					 if (typeof callback == "function"){
			            callback();
			         }
				 }else{
//					 me.getView().unmask();
					 var alertInfomationStore = Ext.create('AFC.store.application.common.AlertInfomation');
					 alertInfomationStore.load({params:{id:appId}})
					 var alertInformation = Ext.create('AFC.view.application.common.AlertInformation');
					 alertInformation.setStore(alertInfomationStore);
					 Ext.create('Ext.window.Window', {
  				     title: '提示',
  				     height: 400,
  				     width: 500,
  				     layout: 'fit',
      				 fbar:[{ 
  							type:'button', text:'关闭',
      						handler: function() {
          				        this.up('window').close();
          				    }
      				 },{ 
  							type:'button', text:'继续',
      						handler: function() {
      							if (typeof callback == "function"){
        				            callback();
        				        }
      							this.up('window').close();
          				    }
      				 }],
  				     items:[alertInformation]
				     }).show();
//					 ExtApp.util.Util.showErrorMsg(result.data);
				 }
		     },
		     failure: function(response, opts) {
		     	 var result = ExtApp.util.Util.decodeJSON(response.responseText); 
		    	 ExtApp.util.Util.showErrorMsg(result.data);
		    }
     });
   },
   onButtonClickCancell: function(button, e, options){
       var me = this;
       var form = this.lookupReference('da022Form1111');
       var appId = form.getForm().findField('id').getValue();
       var win = form.up('window');
//       var dddd = form.getForm().findField('appliedAmountTest').getValue();
//       alert(dddd);
//       return;
       if (form.isValid()){
           me.getView().mask('正在保存... 请耐心等待...');
           form.submit({
           	params:{appId:appId},
               clientValidation: true,
               url: '/afc/da022/da022!cancellWorkflow.action',
               scope: me,
               success: 'onCancellSuccess',
               failure: 'onSubmitFailure'
           });
       }
   },
   
   onCancellSuccess: function(form, action) {
       var view = this.getView();
       view.unmask();
       var form = this.lookupReference('da022Form1111');
       var win = form.up('window');
       win.close();
       Ext.Msg.alert('提示', '取消成功！');
       var grid = win.grid;
       if(grid){
       	grid.getStore().load();
       }
   }
});