/**
 * 质量问题管理-我的待办-问题确认Controller
 */
Ext.define('ExtApp.view.qualityissuemanagement.qedashboard.step3.MyTaskInfo03Controller', {
    extend: 'ExtApp.view.common.IssueStepViewController',
    alias: 'controller.myTaskInfo03',
    // 点击【提交】
    submit: function(btn) {
    	var me = this;
    	var v_form = me.view.getForm();
    	var issueNatureId = v_form.findField('issueNatureId');
    	var reconfirmDateStr = v_form.findField('reconfirmDateStr');
    	var isIssueReason = v_form.findField('isIssueReason');
    	var tempAction = v_form.findField('tempAction');
    	if(issueNatureId.getValue() == "ISSUE_NATURE_3"){
    		reconfirmDateStr.allowBlank = false;
    		isIssueReason.allowBlank = false;
    		tempAction.allowBlank = true;
    	}else if(issueNatureId.getValue() == "ISSUE_NATURE_2"){
    		reconfirmDateStr.allowBlank = true;
    		isIssueReason.allowBlank = false;
    		tempAction.allowBlank = true;
    	}else{
    		reconfirmDateStr.allowBlank = true;
    		isIssueReason.allowBlank = true;
    		tempAction.allowBlank = false;
    	};
    	if(v_form.isValid() == false){
    		Ext.Msg.alert('提示', "请填写必填项！！！");
    		return;
    	}
    	v_form.submit({
    		url: '/pdms/ims/ims-issue!save.action',
            params: {
            	method:'updateIssue',
            	action:'NEXT'
            },
    	    waitMsg : '正在提交数据',
    	    waitTitle : '提示',
    	    method : "POST",
    	    success : function(form, action) {
    	    	var gridTask = me.getView().grid.getStore().load();
    	    	me.getView().close();
    	    },
    	    failure : function(form, action) {
    	    	ExtApp.util.Util.handleFormFailure(action);
    	    }
	    });
    },
    // 点击【保存】
    save: function(btn) {
    	var me = this;
    	var v_form = me.view.getForm();
    	
    	var issueNatureId = v_form.findField('issueNatureId');
    	issueNatureId.allowBlank = true;
    	var isIssueReason = v_form.findField('isIssueReason');
    	isIssueReason.allowBlank = true;
    	var tempActionField = v_form.findField('tempAction');
    	tempActionField.allowBlank = true;
    	var reconfirmDateStr = v_form.findField('reconfirmDateStr');
    	reconfirmDateStr.allowBlank = true;
    	v_form.submit({
    		url: '/pdms/ims/ims-issue!save.action',
            params: {
            	method:'updateIssue',
            	action:'SAVE'
            },
    	    waitMsg : '正在提交数据',
    	    waitTitle : '提示',
    	    method : "POST",
    	    success : function(form, action) {
    	    	var gridTask = me.getView().grid.getStore().load();
    	    	me.getView().close();
    	    },
    	    failure : function(form, action) {
    	    	ExtApp.util.Util.handleFormFailure(action);
    	    }
	    });
    },
    // 点击【回退】
    fallback : function(btn) {
    	var me = this
    	var v_form = me.view.getForm();
    	
    	var issueNatureId = v_form.findField('issueNatureId');
    	issueNatureId.allowBlank = true;
    	var isIssueReason = v_form.findField('isIssueReason');
    	isIssueReason.allowBlank = true;
    	var tempActionField = v_form.findField('tempAction');
    	tempActionField.allowBlank = true;
    	
    	var returnReasonWindow = Ext.create('ExtApp.view.common.ReturnReasonWindow',{
			callback:function(returnComment){
        		if(returnComment == null || returnComment == ''){
        			Ext.Msg.alert('提示', '必须添加备注！');
        			return;
        		}
        		returnReasonWindow.close();
				me.getView().mask('正在提交... 请耐心等待...');
				v_form.submit({
		    		url: '/pdms/ims/ims-issue!save.action',
		            params: {
		            	returnComment:returnComment,
		            	method:'updateIssue',
		            	action:'RETURN'
		            },
		    	    waitMsg : '正在提交数据',
		    	    waitTitle : '提示',
		    	    method : "POST",
		    	    success : function(form, action) {
		    	    	var gridTask = me.getView().grid.getStore().load();
		    	    	me.getView().close();
		    	    },
		    	    failure : function(form, action) {
		    	    	ExtApp.util.Util.handleFormFailure(action);
		    	    }
			    });
			}
		});
    	returnReasonWindow.show();
		return;
    },
    // 点击【合并】
    applyMerge : function(btn) {
    	var me = this
    	var v_form = me.view.getForm();
    	
    	var issueNatureId = v_form.findField('issueNatureId');
    	issueNatureId.allowBlank = true;
    	var isIssueReason = v_form.findField('isIssueReason');
    	isIssueReason.allowBlank = true;
    	var tempActionField = v_form.findField('tempAction');
    	tempActionField.allowBlank = true;
    	
    	var returnReasonWindow = Ext.create('ExtApp.view.common.ReturnReasonWindow',{
			callback:function(returnComment){
        		if(returnComment == null || returnComment == ''){
        			Ext.Msg.alert('提示', '必须添加备注！');
        			return;
        		}
        		returnReasonWindow.close();
				me.getView().mask('正在提交... 请耐心等待...');
				v_form.submit({
		    		url: '/pdms/ims/ims-issue!save.action',
		            params: {
		            	returnComment:returnComment,
		            	method:'updateIssue',
		            	action:'APPLY_MERGE'
		            },
		    	    waitMsg : '正在提交数据',
		    	    waitTitle : '提示',
		    	    method : "POST",
		    	    success : function(form, action) {
		    	    	var gridTask = me.getView().grid.getStore().load();
		    	    	me.getView().close();
		    	    },
		    	    failure : function(form, action) {
		    	    	ExtApp.util.Util.handleFormFailure(action);
		    	    }
			    });
			}
		});
    	returnReasonWindow.show();
		return;
    },
	// 点击【问题性质】
    selcombo: function(combo, newValue, oldValue, eOpts) {
    	var me = this.view;
    	var v_form = me.getForm();
    	var reconfirmDateStr = v_form.findField('reconfirmDateStr');
    	var isIssueReason = v_form.findField('isIssueReason');
    	var tempAction = v_form.findField('tempAction');
    	if(newValue == "ISSUE_NATURE_3"){
    		reconfirmDateStr.setHidden(false);
    		reconfirmDateStr.allowBlank = false;
    		reconfirmDateStr.setFieldLabel('再次确认时间&nbsp;<span style="color: red;">*</span>');
    		isIssueReason.allowBlank = false;
    		isIssueReason.setFieldLabel('理由&nbsp;<span style="color: red;">*</span>');
    		tempAction.allowBlank = true;
    		tempAction.setFieldLabel('临时措施');
    	}else if(newValue == "ISSUE_NATURE_2"){
    		reconfirmDateStr.setHidden(true);
    		reconfirmDateStr.allowBlank = true;
    		isIssueReason.allowBlank = false;
    		isIssueReason.setFieldLabel('理由&nbsp;<span style="color: red;">*</span>');
    		tempAction.allowBlank = true;
    		tempAction.setFieldLabel('临时措施');
    	}else{
    		reconfirmDateStr.setHidden(true);
    		reconfirmDateStr.allowBlank = true;
    		reconfirmDateStr.setValue("");
    		isIssueReason.allowBlank = true;
    		isIssueReason.setFieldLabel('理由');
    		tempAction.allowBlank = false;
    		tempAction.setFieldLabel('临时措施&nbsp;<span style="color: red;">*</span>');
    	};
    }
});