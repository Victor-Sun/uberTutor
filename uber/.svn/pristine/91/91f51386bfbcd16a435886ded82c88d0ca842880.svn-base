/**
 * 个人管理-待办任务
 */
Ext.define('ExtApp.view.myworkspace.todopm.TodoListPM',{
	extend:'Ext.tab.Panel',
	xtype:'todoListPM',
	
	controller: 'todoListPM',
	layout: 'fit',

	initComponent: function() {
		var me = this;
		
		var totalStore = Ext.create('ExtApp.store.myworkspace.TodoListPMStore');
		totalStore.load();
		totalStore.on('load',function() {
			me.setTitle('项目任务<font color="red"><b>（' + this.getTotalCount() + '）</b></font>');   
		});
		
		var store = Ext.create('ExtApp.store.myworkspace.TodoListPMStore');
		store.load();
		store.on('beforeload', function() {
			var form = me.down('toolbar').down('form').getForm();
			this.getProxy().extraParams = {
				searchModel: Ext.encode(form.getFieldValues())
			};
    	});
		
		// 平台项目
		var programStore = Ext.create('ExtApp.store.projectmanagement.AllProgramStore');
		programStore.load();
		// 车型
		var vehicleStore = Ext.create('ExtApp.store.projectmanagement.AllVehicleByProgramStore');

		this.items = [{
			title: '列表',
			xtype: 'grid',
			scrollable:'y',
			reference: 'refTodoListPMGrid',
			selModel: 'checkboxmodel',
			store: store,
			columns:[{
				xtype: 'rownumberer'
			},{
				dataIndex:'attCnt',
				renderer: 'renderAttachment',
				align: 'center',
				width: 35,
				filter: false
			},{
				text: '进展状态',
				width: 80,
				dataIndex: 'progressStatus',
				renderer: 'renderIssueProgress',
				align: 'center',
				filter: false
			},{
				text:'风险状态',
				dataIndex:'taskProgressStatusCode',
				renderer: 'renderTaskProgress',
				align: 'center',
				width: 80,
				filter: false
			},{
				text:'任务名称',
				dataIndex:'taskName',
				flex: 1
			},{
				text:'任务类型',
				dataIndex:'taskTypeName',
				flex: 1
			},{
				text:'项目',
				dataIndex:'programCode',
				flex: 1
			},{
				text:'车型',
				dataIndex:'programVehicleCode',
				flex: 1
			},{
				text:'优先级',
				dataIndex:'taskPriorityName',
				flex: 1,
				sortable: true
			},{
				text:'计划偏离天数',
				dataIndex:'delayDays',
				flex: 1,
				filter: {
					type: 'number'
				}
			},{
				text:'责任人',
				dataIndex:'taskOwnerName',
				flex: 1
			},{
				text:'发布人',
				dataIndex:'publishByName',
				flex: 1
			},{
				text:'最近更新时间',
				dataIndex:'lastReportDate',
				formatter: 'date("Y/m/d H:i:s")',
				flex: 1,
				filter: {
					type: 'date'
				}
			},{
				text:'计划完成时间',
				dataIndex:'plannedFinishDate',
				formatter: 'date("Y/m/d")',
				flex: 1,
				filter: {
					type: 'date'
				}
			}],
			tbar: [{
				xtype: 'form',
		    	margin: 2,
		    	layout:{
					type:'vbox',
					align:'stretch'
				},
				width: '100%',
				items: [{
					xtype: 'fieldset',
					flex:1,
			    	title: '<B>高级查询</B>',
			    	titleAlign: 'right',
			    	collapsible:true,
			    	collapsed: true,
			    	margin: 2,
			    	layout: 'fit',
			    	items: [{
			    		xtype: 'panel',
			    		layout: {
			    			type:'vbox',
							align:'stretch'
			    		},
			    		defaults: {
			    			margin: 5,
			    			flex: 1,
			    			layout: {
				    			type:'hbox',
								align:'stretch'
				    		}
			    		},
			    		items: [{
			    			xtype: 'panel',
				    		items: [{
				    			xtype: 'combo',
				    			fieldLabel: '平台项目',
				    		    name: 'searchProgram',
				    		    store: programStore,
				    		    queryMode: 'local',
				    		    displayField: 'programCode',
				    		    valueField: 'id',
				    		    forceSelection: true,
				    		    width: 400,
				    			listeners: {
				    				change: function(combo, newValue, oldValue, eOpts) {
				    					vehicleStore.load({params:{programId: newValue}});
				    				}
				    		    }
				    		},{
				    		    xtype: 'combo',
				    		    margin: '0 0 0 20',
				    		    labelAlign: 'right',
				    			fieldLabel: '车型',
				    		    name: 'searchVechile',
				    		    store: vehicleStore,
				    		    queryMode: 'local',
				    		    displayField: 'vehicleCode',
				    		    valueField: 'id',
				    		    forceSelection: true
				    		}]
			    		},{
			    			xtype: 'panel',
				    		items: [{
				    			xtype: 'displayfield',
				    			value: '进度风险:'
				    		},{
				    			xtype:'checkbox',
								name:'searchRisk_1',
								checked: true,
								margin: '0 0 0 10',
								labelWidth: 40,
								labelSeparator: '',
								fieldLabel:'无风险'
			    			},{
			    				xtype:'checkbox',
								name:'searchRisk_2',
								checked: true,
								margin: '0 0 0 10',
								labelWidth: 40,
								labelSeparator: '',
								fieldLabel:'小风险'
			    			},{
			    				xtype:'checkbox',
								name:'searchRisk_3',
								checked: true,
								margin: '0 0 0 10',
								labelWidth: 40,
								labelSeparator: '',
								fieldLabel:'中风险'
			    			},{
			    				xtype:'checkbox',
								name:'searchRisk_4',
								checked: true,
								margin: '0 0 0 10',
								labelWidth: 40,
								labelSeparator: '',
								fieldLabel:'大风险'
			    			},{
			    				xtype:'checkbox',
								name:'searchRisk_5',
								checked: true,
								margin: '0 0 0 10',
								labelWidth: 60,
								labelSeparator: '',
								fieldLabel:'无法判断'
				    		}]
			    		},{
			    			xtype: 'panel',
				    		items: [{
				    			xtype: 'displayfield',
				    			value: '任务状态:'
				    		},{
				    			xtype:'checkbox',
								name:'searchWaiting',
								checked: true,
								margin: '0 0 0 10',
								labelWidth: 40,
								labelSeparator: '',
								fieldLabel:'未开始'
					    	},{
								xtype:'checkbox',
								name:'searchProcessing',
								checked: true,
								margin: '0 0 0 10',
								labelWidth: 40,
								labelSeparator: '',
								fieldLabel:'进行中'
				    		}]
			    		},{
			    			xtype: 'panel',
				    		items: [{
				    			xtype: 'textfield',
								name: 'searchTaskName',
								fieldLabel: '任务名称'
				    		}]
			    		}]
			    	}]
				},{
					xtype: 'container',
					margin: 5,
		    		layout:{
						type:'hbox',
						align:'stretch'
					},
					items: [{
						xtype : 'numberfield',
						fieldLabel : '近',
						name:'searchDaysVal',
						labelAlign: 'right',
						labelWidth: 10,
						width: 100,
//						value: 7,
						listeners: {
		    				change: function(text, newValue, oldValue, eOpts) {
		    					if (newValue != null && newValue != '') {
		    						var form = me.down('toolbar').down('form').getForm();
		    						form.findField('searchDueDateTo').setValue(null);
		    					}
		    				}
		    		    }
					},{
						xtype: 'displayfield',
		    			value: '天'
					},{
						xtype:'checkbox',
						name:'searchExpired',
						margin: '0 0 0 20',
						labelWidth: 60,
						checked: true,
						labelSeparator: '',
						fieldLabel:'过期任务'
					},{
						xtype: 'datefield',
						margin: '0 0 0 20',
						format: 'Y/m/d',
						name: 'searchDueDateTo',
						labelAlign: 'right',
						fieldLabel:'计划完成日期',
						listeners: {
		    				change: function(df, newValue, oldValue, eOpts) {
		    					if (newValue != null && newValue != '') {
		    						var form = me.down('toolbar').down('form').getForm();
		    						form.findField('searchDaysVal').setValue(null);
		    					}
		    				}
		    		    }
					},{
						xtype: 'button',
						margin: '0 0 0 20',
						text: '查询',
						iconCls: 'x-fa fa-search',
						handler: 'search'
					},{
						xtype: 'button',
						margin: '0 0 0 5',
						text: '重置',
						iconCls: 'x-fa fa-rotate-left',
						handler: 'reloadSearch'
			    	},{
			    		xtype: 'button',
						text: '移交',
						margin: '0 0 0 5',
						iconCls: 'fa fa-share',
						handler: 'transferTask'
					}]
				}]
			}],
			dockedItems: [{
			     xtype: 'pagingtoolbar',
			     dock: 'bottom',
			     displayInfo: true,
			     store: store
			}],
			listeners:{
	        	celldblclick: 'onCelldblclick'
			}
		}];
		this.callParent();
	}
});