Ext.define('ExtApp.view.myworkspace.task.PmTaskPerformanceController', {
    extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.pmTaskPerformance',
    
    // 初始化
    init: function() {
    	// 执行画面以外
    	if (this.view.viewFlag != 'performance') {
        	// 隐藏执行状况Button
    		this.view.query('#btnStartTask')[0].setHidden(true);
    		this.view.query('#btnSaveTask')[0].setHidden(true);
    		this.view.query('#btnComplete')[0].setHidden(true);
    		this.view.query('#dispItemPriority')[0].setHidden(true);
    		this.view.query('#dispItemMemo')[0].setHidden(true);
        	// 执行状况Text只读
    		this.view.query('#comTaskPriorityCode')[0].setReadOnly(true);
    		this.view.query('#comTaskPriorityCode')[0].fieldCls = 'text-readonly';
    		this.view.query('#taMemo')[0].setReadOnly(true);
    		this.view.query('#taMemo')[0].fieldCls = 'text-readonly';
    	// 执行画面
    	} else {
    		// 若未开始，则不能点击完成按钮
    		if (this.view.taskStatusCode == 'TASK_STATUS_NOT_START') {
    			this.view.query('#btnComplete')[0].setDisabled(true);
    		// 若已开始，则不能点击开始按钮
    		} else if (this.view.taskStatusCode == 'TASK_STATUS_IN_PROCESS') {
    			this.view.query('#btnStartTask')[0].setDisabled(true);
    		}
    	}
    },

    // 任务开始
    startTask: function(btn, e) {
    	var me = this;
        Ext.Ajax.request({
    	    url: '/pdms/mw/todo-list!startTask.action',
    	    params: {
    	    	taskId: me.view.taskId
    	    },
    	    scope: me,
    	    success: function(response, opts) {
    	    	var obj = Ext.decode(response.responseText);
		        if (obj.success) {
		        	me.view.load({
		    			url: '/pdms/mw/todo-list!getTodoTaskInfo.action',
		    			params: {
		    				processTaskId: me.view.processTaskId
		    			}
		    		});
		        	me.view.up('pmTask').down('pmTaskGeneral').load({
		    			url: '/pdms/mw/todo-list!getTodoTaskInfo.action',
		    			params: {
		    				processTaskId: me.view.processTaskId
		    			}
		    		});
		        	// 开始按钮不能重复点击
		        	btn.setDisabled(true);
		        	this.view.query('#btnComplete')[0].setDisabled(false);		        	
		        	// 状态更改为开始执行
		        	me.view.up('pmTask').taskStatusCode = obj.data.TASK_STATUS_CODE;
		        	// 更改进展状态为正常进行
		        	me.view.up('pmTask').taskProgressStatusCode = obj.data.TASK_PROGRESS_STATUS_CODE;
		        	var img = 'resources/images/'
		        			+ me.view.up('pmTask').controller.getProgressImage(
		        					obj.data.TASK_PROGRESS_STATUS_CODE);
		        	me.view.up('pmTask').query('#progressStatus')[0].setSrc(img);
		        } else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
    	    },
    	    failure: function(response, opts) {
    	    	ExtApp.util.Util.handleRequestFailure(response);
    	    }
        });
    },
    
	// 任务完成
    completeTask: function(btn) {
    	var me = this;
    	Ext.Ajax.request({
            url: '/pdms/mw/todo-list!completeTask.action',
            params: {
            	taskId: me.view.taskId,
            	processId: me.view.processId
			},
            scope: me,
   	 	 	success: function(response, opts) {
    	    	var obj = Ext.decode(response.responseText);
    	        if (obj.success) {
    	        	ExtApp.util.Util.showToast("任务已提交审核！");
    	        	me.view.up('pmTask').controller.closeTask();
    	        } else {
    	        	ExtApp.util.Util.handleRequestFailure(response);
    	        }
    	 	},
 		    failure: function(response, opts) {
 		    	ExtApp.util.Util.handleRequestFailure(response);
 		    }
        });
    },
    
    // 任务保存
    saveTask: function(btn, e) {
    	var me = this;
    	var form = this.view.getForm();
		Ext.Ajax.request({
			url: '/pdms/mw/todo-list!saveTask.action',
    	    params: {
    	    	taskId: me.view.taskId,
    	    	model: Ext.encode(form.getFieldValues())
    	    },
    	    scope: me,
    	    success: function(response, opts) {
    	    	var obj = Ext.decode(response.responseText);
		        if (obj.success) {
		    		me.view.load({
		    			url: '/pdms/mw/todo-list!getTodoTaskInfo.action',
		    			params: {
		    				processTaskId: me.view.processTaskId
		    			}
		    		});
		    		me.view.up('pmTask').down('pmTaskGeneral').load({
		    			url: '/pdms/mw/todo-list!getTodoTaskInfo.action',
		    			params: {
		    				processTaskId: me.view.processTaskId
		    			}
		    		});
		        	ExtApp.util.Util.showToast("任务保存成功！");
		        } else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
    	    },
    	    failure: function(response, opts) {
    	    	ExtApp.util.Util.handleRequestFailure(response);
    	    }
		});
    }
});
