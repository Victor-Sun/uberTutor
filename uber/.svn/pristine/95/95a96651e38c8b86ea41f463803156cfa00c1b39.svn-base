Ext.define('ExtApp.view.projectManagement.issue.archiveissue.ArchiveIssueInfoForm',{
	xtype:'archiveIssueInfoForm',
	extend:'Ext.form.Panel',
	reference: 'archiveIssueInfoForm',
	
	scrollable: true,
	controller: 'archiveIssueForm',
	itemId:'confirmFormItemId',
	url: '/pdms/pm/project-open-issue!getIssueForm.action',
	initComponent: function() {
		var me = this;
		// OpenIssue优先级
		var priorityStore = Ext.create('ExtApp.store.common.CodeTableStore');
		priorityStore.getProxy().extraParams = {type: 'ISSUE_PRIORITY'};
		priorityStore.load();
		
		// 问题来源
		var issueSourceStore = Ext.create('Ext.data.Store', {
		    fields: ['id', 'name'],
		    proxy: {
		    	type: 'ajax',
		    	url: '/pdms/pm/project-open-issue!getIssueSourceList.action',
		        reader: {
		            type: 'json',
		            rootProperty: 'data'
		        }
		    },
		    autoLoad: true
		});
		
		// 问题类型
		var issueTypeStore = Ext.create('Ext.data.Store', {
		    fields: ['id', 'name'],
		    proxy: {
		    	type: 'ajax',
		    	url: '/pdms/pm/project-open-issue!getIssueTypeList.action',
		        reader: {
		            type: 'json',
		            rootProperty: 'data'
		        }
		    },
		    autoLoad: true
		});
		
		// Create the combo box, attached to the states data store
		var issueSource = Ext.create('Ext.form.ComboBox', {
		    fieldLabel: '问题来源',
		    flex: 1,
		    store: issueSourceStore,
		    name:'issueSourceId',
		    queryMode: 'local',
		    displayField: 'name',
		    allowBlank:false,
		    valueField: 'id'
		});
		
		// 问题类型
		var issueType = Ext.create('Ext.form.ComboBox', {
		    fieldLabel: '问题类型',
		    flex: 1,
		    store: issueTypeStore,
		    name:'issueTypeId',
		    queryMode: 'local',
		    displayField: 'name',
		    allowBlank:false,
		    valueField: 'id'
		});
		
		var responsibleUserStore = Ext.create('Ext.data.Store', {
		    fields: ['id', 'name'],
		    proxy: {
		    	type: 'ajax',
		    	url: '/pdms/pm/project-open-issue!getResponsibleUser.action',
		        reader: {
		            type: 'json',
		            rootProperty: 'data'
		        }
		    }
		});
		
		// Create the combo box, attached to the states data store
		var responsibleUser = Ext.create('Ext.form.ComboBox', {
		    fieldLabel: '责任人',
		    flex: 1,
		    store: responsibleUserStore,
		    name:'respUserId',
		    queryMode: 'local',
		    displayField: 'name',
		    allowBlank:false,
		    valueField: 'id'
		});
		
		var responsibleObsStore = Ext.create('Ext.data.Store', {
		    fields: ['id', 'name'],
		    proxy: {
		    	type: 'ajax',
		    	url: '/pdms/pm/project-open-issue!getResponsibleObsList.action',
		        reader: {
		            type: 'json',
		            rootProperty: 'data'
		        }
		    }
		});
		
		// Create the combo box, attached to the states data store
		var responsibleObs = Ext.create('Ext.form.ComboBox', {
		    fieldLabel: '责任组',
		    flex: 1,
		    store: responsibleObsStore,
		    name:'obsId',
		    queryMode: 'local',
		    displayField: 'name',
		    allowBlank:false,
		    valueField: 'id',
			listeners: {
				change: function(th,newValue, oldValue, eOpts){
					responsibleUserStore.load({params:{obsId:newValue}});
				}
		    }
		});
		
		var vehicleStore = Ext.create('Ext.data.Store', {
		    fields: ['id', 'name'],
		    proxy: {
		    	type: 'ajax',
		    	url: '/pdms/pm/project-open-issue!getVehicleList.action',
		        reader: {
		            type: 'json',
		            rootProperty: 'data'
		        }
		    }
		});
		
		// Create the combo box, attached to the states data store
		var vehicle = Ext.create('Ext.form.ComboBox', {
		    fieldLabel: '车型',
		    flex: 1,
		    store: vehicleStore,
		    name:'programVehicleId',
		    queryMode: 'local',
		    displayField: 'name',
		    allowBlank:false,
		    valueField: 'id',
			listeners: {
				change: function(th,newValue, oldValue, eOpts){
					responsibleObsStore.load({params:{programVehicleId:newValue}});
				}
		    }
		});
		
		var programStore = Ext.create('ExtApp.store.projectmanagement.ProjectListNoPagingStore');
		programStore.load();
		var program = Ext.create('Ext.form.ComboBox', {
		    fieldLabel: '项目',
		    flex: 1,
		    store: programStore,
		    name:'programId',
		    queryMode: 'local',
		    displayField: 'code',
		    allowBlank:false,
		    valueField: 'id',
			listeners: {
				change: function(th,newValue, oldValue, eOpts){
					vehicleStore.load({params:{programId:newValue}});
				}
		    }
		});
		
		me.items = [{
			xtype: 'fieldset',
			title: '基本信息',
			margin: 20,
			items: [{
				xtype:'panel',
				layout:{
					type:'vbox',
					align:'stretch'
				},
				defaults: {
					defaults: {
						readOnly: true,
						fieldCls: 'text-readonly',
						labelAlign: 'right',
						margin: 5,
						labelWidth: 100
					}
				},
				items:[{
					xtype:'panel',
					layout:{
						type:'hbox',
						align:'stretch'
					},
					items:[{
						xtype: 'textfield',
						flex: 2,
						fieldLabel: '标题',
						name: 'title'
					},{
						xtype: 'textfield',
						flex: 1,
						fieldLabel: '录入人',
						name: 'createByName'
					},{
						xtype:'hiddenfield',
				        name: 'createBy'
					},{
						xtype: 'textfield',
						flex: 1,
						fieldLabel: '提出人',
						name: 'raiseByName'
					},{
						xtype:'hiddenfield',
				        name: 'raiseBy'
					}]
				},{
					xtype:'panel',
					layout:{
						type:'hbox',
						align:'stretch'
					},
					items:[{
				        xtype:'hiddenfield', 
				        name: 'id'
					}, program, vehicle, issueSource, issueType]
				},{
					xtype:'panel',
					flex: 1,
					layout:{
						type:'hbox',
						align:'stretch'
					},
					items:[{
						xtype:'counterTextArea',
						flex: 1,
						name:'issueDescription',
						letterPadding:'2 0 0 105',
						enforceMaxLength:true,
						maxLength:500,
						fieldLabel:'问题描述'
					}]
				},{
					xtype:'panel',
					layout:{
						type:'hbox',
						align:'stretch'
					},
					items:[responsibleObs,responsibleUser,{
						xtype: 'datefield',
						flex: 1,
						fieldLabel: '计划完成日期',
						name: 'dueDate',
						format: 'Y-m-d'
                    },{
                    	xtype: 'combobox',
						flex: 1,
						fieldLabel: '优先级',
						store: priorityStore,
					    queryMode: 'local',
					    displayField: 'name',
					    valueField: 'code',
					    name: 'issuePriorityCode',
					    forceSelection: true
					}]
				},{
					xtype:'panel',
					flex: 1,
					layout:{
						type:'hbox',
						align:'stretch'
					},
					items:[{
						xtype: 'displayfield',
						flex: 1,
						fieldLabel: '进度状态',
						labelSeparator: '',
				        name: 'progressStatus',
				        renderer: function(value) {
				        	return '<div>' + me.controller.renderIssueProgress(value) + '</div>';
				        },
						fieldCls: ''
					},{
						xtype: 'datefield',
						flex: 1,
						fieldLabel: '实际完成日期',
						name: 'actualFinishDate',
						format: 'Y-m-d'
			       },{
			    	    xtype: 'numberfield',
			    	    flex: 1,
						fieldLabel: '偏离计划天数',
						name: 'departedDays'
			       },{
			    	   xtype: 'panel',
			    	   flex: 1
			       }]
				}]
			}]
		},{
			xtype: 'fieldset',
			title: '备注',
			margin: 20,
			items: [{
				xtype:'panel',
				layout:{
					type:'vbox',
					align:'stretch'
				},
				items:[{
					xtype:'counterTextArea',
					flex: 1,
					name:'issueCause',
					enforceMaxLength:true,
					maxLength:500,
					readOnly: true,
					fieldCls: 'text-readonly'
				}]
			}]
		}];
		me.callParent(arguments);
	},
	setReadOnly:function(flag){
		var me = this;
	}
});