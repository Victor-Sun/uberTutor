/**
 * 部门空间-部门自建任务-列表
 */
Ext.define('ExtApp.view.deptworkspace.deptissue.DeptIssueController', {
    extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.deptIssue',
    
    // 初始化
    init: function() {
    	var me = this;
    	var privilegeStore = Ext.create('ExtApp.store.common.SysPrivilegeStore');
    	// 提出问题权限判定
    	privilegeStore.load({params: {privilegeCode: '800304'}});
    	privilegeStore.on('load', function() {
    		if (this.data.getAt(0).data.privilege) {
    			me.view.query('#btnRaiseIssue')[0].show();
    		}
    	});
    },

    // 双击列表
    onCelldblclick: function(grid, td, cellIndex, record, tr, rowIndex, e, eOpts) {
    	var me = this;
    	var rec = grid.getStore().getAt(rowIndex);
    	// 打开窗口
    	var issueWin = Ext.create({
    		xtype: 'viewDeptIssueWindow',
    		issueId: rec.get('id'),
    		issueUuid: rec.get('uuid'),
    		statusCode: rec.get('statusCode'),
    		parentCaller: me
    	});
    	issueWin.down('deptIssueForm').load({
    		params: {issueId:rec.get('id')}
    	});
    	issueWin.show();
    },
    
    // 选中列表数据
    onSelectionChange: function(grid, records, eOpts) {
        if (records[0]) {
        	this.view.query('#detailForm')[0].getForm().loadRecord(records[0]);
        	this.view.query('#detailForm')[0].issueId = records[0].get('id');
        	this.view.query('#detailForm')[0].issueUuid = records[0].get('uuid');
        }
    },
    
    // 提交问题
    raiseIssue:function(){
    	var me = this;
    	Ext.create({
    		xtype: 'raiseDeptIssueWindow',
    		parentCaller: me
    	}).show();
    },
    
    // 刷新Grid
    refreshView: function() {
    	this.view.down('grid').store.reload();
    },
    
    // 查询
    search: function(btn, e) {
    	var me = this;
    	me.view.mask('Please Waiting...');
    	var form = me.view.down('toolbar').down('form').getForm();
    	var store = Ext.create(
			'ExtApp.store.deptworkspace.DeptIssueStore');
    	store.getProxy().extraParams = {
			searchModel: Ext.encode(form.getFieldValues())
		};
    	store.load();
    	store.on('load', function() {
    		me.view.down('grid').setStore(this);
    		me.view.down('pagingtoolbar').setStore(this);
    		me.view.unmask();
    	});
    },
    
    // 重置
    reloadSearch: function() {
    	var me = this;

    	var form = this.view.down('toolbar').down('form').getForm();
    	Ext.each(form.getFields().items, function(field) {
    		if (field.xtype != 'displayfield') {
    			if (field.xtype == 'checkbox') {
        			field.setValue(true);
        		} else {
        			field.setValue('');
        		}
    		}
		});
    	this.search();
    },
    
    // 评论
    comment: function() {
    	var me = this;
    	if (! me.view.query('#detailForm')[0].issueId ||
    			me.view.query('#detailForm')[0].issueId == '' ||
    			me.view.query('#detailForm')[0].issueId == null) {
    		ExtApp.util.Util.showErrorMsg('请选择要评论的问题!');
    		return;
    	}
    	Ext.create({
    		xtype: 'issueCommentWindow',
    		sourceId:me.view.query('#detailForm')[0].issueUuid,
			source:'PM-DEPT-ISSUE-COMMENT',
    		parentCaller: me
    	}).show();
    },
    
    // 打印
    printIssue: function() {
    	var me = this;
    	if (! me.view.query('#detailForm')[0].issueId ||
    			me.view.query('#detailForm')[0].issueId == '' ||
    			me.view.query('#detailForm')[0].issueId == null) {
    		ExtApp.util.Util.showErrorMsg('请选择要打印的问题!');
    		return;
    	}
    	var url = 'rpt=pm/pm_dept_issue_info.brt&params=issueId='
    		    + me.view.query('#detailForm')[0].issueId;
    	ExtApp.util.Util.openReport(url);
    },
    
    // 导出
    export2Excel:function(){
    	var me = this;
    	var url = 'rpt=pm/pm_dept_issue_list.brt&emitter=toxls';
    	// 查询条件
    	var params = '';
    	var form = me.view.down('toolbar').down('form').getForm();
    	// 标题
    	if (form.findField('searchIssueTite').value !='') {
    		params += 'searchIssueTite=' + form.findField('searchIssueTite').value + ';';
    	}
    	// 状态
    	var statusCode = "";
    	if (form.findField('searchWaiting').checked) {
    		statusCode += "'OPEN'";
    	}
    	if (form.findField('searchProcessing').checked) {
    		if (statusCode.length > 0) {
    			statusCode += ",";
    		}
    		statusCode += "'PENDING'";
    	}
    	if (form.findField('searchComplete').checked) {
    		if (statusCode.length > 0) {
    			statusCode += ",";
    		}
    		statusCode += "'COMPLETE'";
    	}
    	if (statusCode.length > 0) {
    		params += 'searchStatusCode=' + statusCode + ';';
    	}
    	// 计划完成时间From
    	if (form.findField('searchDueDateFrom').value != '' && form.findField('searchDueDateFrom').value != null) {
    		params += 'searchDueDateFrom=' + ExtApp.util.Util.formatDate(form.findField('searchDueDateFrom').value, '-') + ';';
    	}
    	// 计划完成时间To
    	if (form.findField('searchDueDateTo').value != '' && form.findField('searchDueDateTo').value != null) {
    		params += 'searchDueDateTo=' + ExtApp.util.Util.formatDate(form.findField('searchDueDateTo').value, '-') + ';';
    	}
    	// 实际完成时间From
    	if (form.findField('searchAFDateFrom').value != '' && form.findField('searchAFDateFrom').value != null) {
    		params += 'searchAFDateFrom=' + ExtApp.util.Util.formatDate(form.findField('searchAFDateFrom').value, '-') + ';';
    	}
    	// 实际完成时间To
    	if (form.findField('searchAFDateTo').value != '' && form.findField('searchAFDateTo').value != null) {
    		params += 'searchAFDateTo=' + ExtApp.util.Util.formatDate(form.findField('searchAFDateTo').value, '-') + ';';
    	}
    	// 责任部门
    	if (form.findField('searchRespDept').value !='') {
    		params += 'searchRespDept=' + form.findField('searchRespDept').value + ';';
    	}
    	// 责任人
    	if (form.findField('searchRespUser').value !='') {
    		params += 'searchRespUser=' + form.findField('searchRespUser').value + ';';
    	}
    	if (params.length > 0) {
    		url += '&params=' + params;
    	}
    	ExtApp.util.Util.openReport(url);
    }

});