/**
 * 个人管理-待办任务-交付物详细
 */
Ext.define('ExtApp.view.myworkspace.task.PmTaskDeliverableDetailController', {
    extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.pmTaskDeliverableDetail',
    
    // 初始化
    init: function() {
    	var grid = this.view.down('grid');
    	var memoText = this.view.down('textareafield');
    	// 执行画面以外
    	if (this.view.viewFlag != 'performance') {
			// 不可输入备注
    		memoText.setReadOnly(true);
    		memoText.fieldCls = 'text-readonly';
    		// 隐藏保存按钮
    		this.view.tools[0].hidden = true;
    	}
    },

	// 确定
    confirm: function(btn) {
    	var me = this;
    	var form = btn.up('pmTaskDeliverableDetail').down('form').getForm();
    	Ext.Ajax.request({
            url: '/pdms/mw/todo-list!saveDeliverable.action',
            params: {
            	taskId: me.view.taskId,
            	deliverableId: me.view.deliverableId,
            	memo: form.findField('memo').value
			},
            scope: me,
   	 	 	success: function(response, opts) {
    	    	var obj = Ext.decode(response.responseText);
    	        if (obj.success) {
    	        	// 一览画面Grid刷新
    	        	me.view.parentCaller.confirmDeliverableDetail();
    	    		me.cancel();
    	        } else {
    	        	ExtApp.util.Util.handleRequestFailure(response);
    	        }
    	 	},
 		    failure: function(response, opts) {
 		    	ExtApp.util.Util.handleRequestFailure(response);
 		    }
        });
	},
	
	// 取消
	cancel: function(btn) {
		this.view.destroy();
	},
	
	// 上传附件CallBack
	uploadFileCallBack: function() {
		var me = this;
    	Ext.Ajax.request({
            url: '/pdms/mw/todo-list!uploadDeliverableFileCallBack.action',
            params: {
            	taskId: me.view.taskId
			},
            scope: me,
   	 	 	success: function(response, opts) {
    	    	var obj = Ext.decode(response.responseText);
    	        if (obj.success) {
    	        } else {
    	        	ExtApp.util.Util.handleRequestFailure(response);
    	        }
    	 	},
 		    failure: function(response, opts) {
 		    	ExtApp.util.Util.handleRequestFailure(response);
 		    }
        });
	},
	
	// 删除附件CallBack
	deleteFileCallBack: function() {
		var me = this;
    	Ext.Ajax.request({
            url: '/pdms/mw/todo-list!deleteDeliverableFileCallBack.action',
            params: {
            	taskId: me.view.taskId
			},
            scope: me,
   	 	 	success: function(response, opts) {
    	    	var obj = Ext.decode(response.responseText);
    	        if (obj.success) {
    	        } else {
    	        	ExtApp.util.Util.handleRequestFailure(response);
    	        }
    	 	},
 		    failure: function(response, opts) {
 		    	ExtApp.util.Util.handleRequestFailure(response);
 		    }
        });
	}
});
