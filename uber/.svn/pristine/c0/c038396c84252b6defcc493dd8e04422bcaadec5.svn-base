/**
 * 项目管理-发布计划
 */
Ext.define('ExtApp.view.projectmanagement.deploy.DeployPlanController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.deployPlan',
    
    initFlag: false,
    
    // 初始化
    init: function() {
    	var me = this;
    	var toolbar = this.view.down('toolbar').down('toolbar');
		// 权限控制
    	ExtApp.util.Util.setPrivilegeByAll(
    			toolbar, me.view.projectPrivilege);
    	// SOP编辑权限
		var editSOPPrivilege = ExtApp.util.Util.getPrivilege(
				'P0902', me.view.projectPrivilege, me.view.programVehicleId);
    	// 项目状态、计划状态取得
    	var statusStore = Ext.create(
			'ExtApp.store.projectmanagement.ProjectPlanStatusStore');
    	statusStore.getProxy().extraParams = {
			programVehicleId: me.view.programVehicleId};
		statusStore.load();
		statusStore.on('load', function() {
			var planStatus = this.data.getAt(0).get('planStatus');
	    	// SOP信息
	    	me.view.query('#sopInfoPanel')[0].add({
	    		layout: 'fit',
	        	xtype: 'projectPlanSOP',
				programVehicleId: me.view.programVehicleId,
				editPrivilege: (editSOPPrivilege && planStatus == 'INACTIVE')
	    	});
		});
    },
    
    // 导入模板
    importPlanTemplate: function(btn) {
    	var me = this;
    	Ext.Ajax.request({
    	    url: '/pdms/pm/project-plan!importPlanTemplateCheck.action',
    	 	params: {
    	 		programVehicleId: me.view.programVehicleId
    	 	},
    	 	scope: me,
    	 	success: function(response, opts) {
    	    	var obj = Ext.decode(response.responseText);
    	        if (obj.success) {
    	        	Ext.create({
    	                xtype: 'programTemplate',
    	                programId: me.view.programId,
    	                programVehicleId: me.view.programVehicleId,
    	                sop: obj.data.sop,
    	                parentCaller: me
    	            }).show();
    	        } else {
    	        	ExtApp.util.Util.handleRequestFailure(response);
    	        }
    	 	},
 		    failure: function(response, opts) {
 		    	ExtApp.util.Util.handleRequestFailure(response);
 		    }
        });
    },
    
    // 导出模板
    exportPlanTemplate: function(btn) {
    	var me = this;
        Ext.create({
            xtype: 'exportPlan',
            programVehicleId: me.view.programVehicleId,
            parentCaller: me
        }).show();
    },

    //更新专业经理
    updateFunctionManager: function(editor, context, eOpts) {
    	var me = this;
		if (context.record.get('obsManager') == null) {
			me.view.down('grid').store.reload();
			return;
		}
    	Ext.getBody().mask('Please Waiting...');
		Ext.Ajax.request({
    	    url: '/pdms/pm/project-plan!updateFuncitonManager.action',
    	 	params: {
    	 		userId: context.record.get('obsManager'),
    	 		obsId: context.record.get('obsId')
    	 	},
    	 	scope: me,
    	 	success: function(response, opts) {
    	        Ext.getBody().unmask();
    	    	var obj = Ext.decode(response.responseText);
    	        if (obj.success) {
    	        	me.view.down('grid').store.reload();
    	        	ExtApp.util.Util.showToast("变更专业经理成功！");
    	        } else {
    	        	ExtApp.util.Util.handleRequestFailure(response);
    	        }
    	 	},
 		    failure: function(response, opts) {
 		    	Ext.getBody().unmask();
 		    	ExtApp.util.Util.handleRequestFailure(response);
 		    }
        });
    },
    
    // 刷新页面
    refreshView: function() {
    	this.view.down('grid').store.reload();
    }
});
