/**
 * 部门空间-部门自建任务-草稿列表
 */
Ext.define('ExtApp.view.deptworkspace.deptissue.DraftDeptIssueController', {
    extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.draftDeptIssue',

    // 双击列表
    onCelldblclick: function(grid, td, cellIndex, record, tr, rowIndex, e, eOpts) {
    	var me = this;
    	var rec = grid.getStore().getAt(rowIndex);
    	// 打开窗口
    	var issueWin = Ext.create({
    		xtype: 'raiseDeptIssueWindow',
    		issueId: rec.get('id'),
    		issueUuid: rec.get('uuid'),
    		parentCaller: me
    	});
    	issueWin.down('deptIssueForm').load({
    		params: {issueId:rec.get('id')}
    	});
    	issueWin.show();
    },
    
    // 选中列表数据
    onSelectionChange: function(grid, records, eOpts) {
        if (records[0]) {
        	this.view.query('#detailForm')[0].getForm().loadRecord(records[0]);
        }
    },
    
    // 刷新Grid
    refreshView: function() {
    	this.view.down('grid').store.reload();
    },
    
    // 查询
    search: function(btn, e) {
    	var me = this;
    	me.view.mask('Please Waiting...');
    	var form = me.view.down('toolbar').down('form').getForm();
    	var store = Ext.create(
			'ExtApp.store.deptworkspace.DraftDeptIssueStore');
    	store.getProxy().extraParams = {
			searchModel: Ext.encode(form.getFieldValues())
		};
    	store.load();
    	store.on('load', function() {
    		me.view.down('grid').setStore(this);
    		me.view.down('pagingtoolbar').setStore(this);
    		me.view.unmask();
    	});
    },
    
    // 重置
    reloadSearch: function() {
    	var me = this;

    	var form = this.view.down('toolbar').down('form').getForm();
    	Ext.each(form.getFields().items, function(field) {
    		if (field.xtype != 'displayfield') {
    			if (field.xtype == 'checkbox') {
        			field.setValue(true);
        		} else {
        			field.setValue('');
        		}
    		}
		});
    	this.search();
    },
    
    // 删除草稿
    delDraftIssue: function(grid, rowIndex, colIndex) {
    	var me = this;
    	var rec = grid.getStore().getAt(rowIndex);
    	Ext.MessageBox.confirm('提示', '确认删除该条记录？', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    			me.view.mask('Please Waiting...');
    	    	Ext.Ajax.request({
    	    		url:'/pdms/dws/dept-issue!deleteDraftDeptIssue.action',
    	    		params: {
    	    			issueId: rec.get('id')
    				},
    				scope: me,
    				success: function(response, opts) {
    					me.view.unmask();
    			    	var obj = Ext.decode(response.responseText);
    					if (obj.success) {
    						grid.getStore().reload();
        			    	ExtApp.util.Util.showToast("删除成功！");
    			        } else {
    			        	ExtApp.util.Util.handleRequestFailure(response);
    			        }
    			    },
    				failure: function(response, opts) {
    					me.view.unmask();
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	})
    		}
    	});
	}

});