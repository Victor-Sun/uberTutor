Ext.define('ExtApp.view.myworkspace.task.PmTaskApprovalController', {
    extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.pmTaskApproval',
    
    // 确定
    confirm: function() {
    	var me = this;
    	var url = '';
    	// 更改状态审批
    	if (me.view.progressStatus &&
    			me.view.progressStatus != null &&
    			me.view.progressStatus != '') {
    		if (me.view.action == 'reject') {
        		url = '/pdms/mw/todo-list!rejectChangeStatus.action';
        	} else {
        		url = '/pdms/mw/todo-list!approveChangeStatus.action';
        	}
    	} else {
    		if (me.view.action == 'reject') {
        		url = '/pdms/mw/todo-list!reject.action';
        	} else {
        		url = '/pdms/mw/todo-list!approve.action';
        	}
    	}
    	
    	var form = this.view.down('form').getForm();
        if (form.isValid()) {
        	me.view.mask('Please Waiting...');
        	form.submit({
        		clientValidation: true,
                submitEmptyText: false,
                url: url,
                params: {
                	processId: me.view.processId,
                	processStepId: me.view.processStepId,
                	taskId: me.view.taskId,
                	memo: me.view.down('textarea').value,
                	progressStatus: me.view.progressStatus
    			},
                scope: me,
       	 	 	success: function(form, action) {
       	 	 		me.view.unmask();
    	   	 	 	ExtApp.util.Util.showToast("审批完成！");
    	   	 	 	me.view.parentCaller.confirmApproval();
    	   	 	 	me.closeWindow();
        	 	},
        	 	failure: function(form, action) {
        	 		me.view.unmask();
                	ExtApp.util.Util.handleFormFailure(action);
                }
        	});
        }
    },

    // 关闭
    closeWindow: function() {
    	this.view.close();
    }
});
