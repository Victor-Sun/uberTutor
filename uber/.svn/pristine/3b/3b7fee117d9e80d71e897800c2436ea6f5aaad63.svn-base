/**
 * 项目管理-车型看板-项目总体状态
 */
Ext.define('ExtApp.view.projectmanagement.vehicle.VehicleReportStatusController', {
	extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.vehicleReportStatus',
    
    // 初始化
    init: function() {
    	var me = this;
    	
    	// 编辑项目状态权限控制
    	ExtApp.util.Util.setPrivilegeByItem(
    			this.view.down('toolbar'),
    			this.view.projectPrivilege[this.view.programVehicleId]);
    	me.refreshView();
    },
    
    // 更改状态
    changeReportStatus: function() {
    	Ext.create({
        	xtype: 'changeReportStatus',
        	programId: this.view.programId,
        	programVehicleId: this.view.programVehicleId,
        	statusCodeTotal: this.view.query('#hiddenTotalStatus')[0].value,
        	parentCaller: this
        }).show();
    },
    
    // 刷新页面
    refreshView: function() {
    	var me = this;
    	if(me.view && me.view.query('#totalStatus')){
    		Ext.Ajax.request({
        		url:'/pdms/pm/project-status-report!getReportStatus.action',
        		params: {
        			programVehicleId: me.view.programVehicleId
    			},
    			scope: me,
    			success: function(response, opts) {
    		    	var obj = Ext.decode(response.responseText);
        	        if (obj.success) {
        	        	me.view.query('#totalStatus')[0].setSrc(
        	            		'resources/images/' + this.getReportStatusImg(obj.data.statusCodeTotal));
        	        	var memo = '最近更新时间：' + obj.data.date;
        	        	if (obj.data.memo != null) {
        	        		memo += '\n\r' + obj.data.memo;
        	        	}
        	        	me.view.query('#memo')[0].setValue(memo);
        	        	me.view.query('#hiddenTotalStatus')[0].setValue(obj.data.statusCodeTotal);
        	        } else {
        	        	ExtApp.util.Util.handleRequestFailure(response);
        	        }
    		    },
    			failure: function(response, opts) {
    		    	ExtApp.util.Util.handleRequestFailure(response);
    		    }
        	});
    	}
    },
    
    // 查看历史记录
    viewChangeLog : function() {
    	Ext.create({
        	xtype: 'vehicleRiskChangeLog',
        	programVehicleId: this.view.programVehicleId,
        	parentCaller: this
        }).show();
    }
});