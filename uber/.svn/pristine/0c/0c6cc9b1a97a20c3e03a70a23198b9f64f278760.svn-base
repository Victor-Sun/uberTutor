/**
 * 项目管理-用户自定义文件夹下的文档
 */
Ext.define('ExtApp.view.projectmanagement.document.CustomizeDocumentController', {
    extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.customizeDocument',
    
    // 查询
    search: function(btn, e) {
    	var me= this;
    	var toolbar = this.view.down('toolbar');
    	var searchDocumentName = toolbar.getComponent('searchDocumentName').value;
    	if (me.view.showAll) {
    		this.view.down('grid').getStore().load({
        		params:{
        			programId: me.view.programId,
        			searchDocumentName: searchDocumentName
        	}});
    	} else {
    		this.view.down('grid').getStore().load({
        		params:{
        			programId: me.view.programId,
        			sourceId: me.view.nodeId,
        			searchDocumentName: searchDocumentName
        	}});
    	}
    },
    
    // 重置
    reloadSearch: function() {
    	var toolbar = this.view.down('toolbar');
    	toolbar.getComponent('searchDocumentName').setValue('');
    	this.search();
    },
    
    // 文件下载
    onFileClick: function(grid, td, rowIndex, cellIndex, e, record, tr) {
    	window.location.href = "/pdms/com/document!downloadDocument.action?"
    			+ "revisionId=" + record.data.documentRevisionId
    			+ "&documentIdxId=" + record.data.docmentIndexId;
    },
    
	// 上传文件
    uploadFile: function() {
    	var me = this;
    	Ext.create({
    		xtype: 'fileUpload',
    		programId: me.view.programId,
    		sourceType: me.view.sourceType,
    		sourceId: me.view.nodeId,
    		folderId: me.view.nodeId,
    		parentCaller: me
    	}).show();
    },
    
	// 上传新版本
    newRevision: function(grid, rowIndex) {
    	var me = this;
    	var record = grid.getStore().getAt(rowIndex);
    	Ext.create({
    		xtype: 'fileUpload',
    		programId: me.view.programId,
    		sourceType: me.view.sourceType,
    		sourceId: me.view.nodeId,
    		folderId: me.view.nodeId,
    		revisionId: record.get('documentRevisionId'),
    		parentCaller: me
    	}).show();
    },
    
    // 上传文件-确定
    confirmUpload: function() {
    	this.view.down('grid').store.reload();
    },
    
    // 删除文件
    deleteFile: function(grid, rowIndex) {
    	var me = this;
    	var record = grid.getStore().getAt(rowIndex);
    	Ext.MessageBox.confirm('提示', '您确定要删除该条记录吗?', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    	    	Ext.Ajax.request({
    	    		url:'/pdms/com/document!deleteDocument.action',
    	    		params: {
    	    			documentIdxId: record.data.docmentIndexId
    				},
    				scope: me,
    				success: function(response, opts) {
    					var obj = Ext.decode(response.responseText);
    					if (obj.success) {
    						grid.getStore().reload();
        			    	ExtApp.util.Util.showToast("删除成功！");
    			        } else {
    			        	ExtApp.util.Util.handleRequestFailure(response);
    			        }
    			    },
    				failure: function(response, opts) {
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	})
    		}
    	});
    },
    showHistoryRevision: function(grid, rowIndex) {
    	var me = this;
    	var record = grid.getStore().getAt(rowIndex);
    	var win = Ext.create('Ext.window.Window',{title:'文档历史版本',width:600,height:400,modal:true});
    	win.add({
    		xtype:'historyRevision',
    		documentId:record.get('documentId')
    	})
    	win.show();
    }
});
