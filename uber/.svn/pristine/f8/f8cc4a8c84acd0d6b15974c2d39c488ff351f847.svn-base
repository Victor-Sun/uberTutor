/**
 * 附件列表
 */
Ext.define('ExtApp.view.qualityissuemanagement.qedashboard.ImsSubmitAttachmentController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.imsSubmitAttachment',

	// 上传附件
    uploadFile: function() {
    	var me = this;
		//生成初始草稿
    	var v_form_sub = me.view.up().up('form');
    	var v_form = v_form_sub.getForm();
    	v_form_sub.lookupController().setAllowBlank(true);
    	v_form.submit({
    		url: '/pdms/ims/ims-issue!save.action',
            params: {
            	model: Ext.encode(v_form.getFieldValues()),
            	keyId: me.view.keyId,
            	taskId: me.view.taskId,
            	ProcessInstanceId: me.view.ProcessInstanceId,
            	method:'updateIssue',
            	action:'SAVE'
            },
            scope: this,
    	    success : function(form, action) {
 		    	v_form_sub.keyId = action.result.data;
 		    	v_form.findField('id').setValue(action.result.data);
 		    	me.view.sourceId = action.result.data;
 		    	Ext.create({
 		    		xtype: 'fileUpload',
 		    		programId: me.view.programId,
 		    		sourceType: me.view.sourceType,
 		    		sourceId: me.view.sourceId,
 		    		parentCaller: me
 		    	}).show();
    	    },
    	    failure: function(form, action) {
    	    	ExtApp.util.Util.handleFormFailure(action);
    	    }
    	});
    },
    
    // 上传附件-确定
    confirmUpload: function() {
    	this.view.store.getProxy().extraParams = {
			sourceType: this.view.sourceType, sourceId: this.view.sourceId};
    	this.view.store.load();
    },
    
    // 删除附件
    deleteFile: function(grid, rowIndex) {
    	var me = this;
    	var record = grid.getStore().getAt(rowIndex);
    	Ext.MessageBox.confirm('提示', '您确定要删除该条记录吗?', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    	    	Ext.Ajax.request({
    	    		url:'/pdms/com/document!deleteDocument.action',
    	    		params: {
    	    			documentIdxId: record.data.id
    				},
    				scope: me,
    				success: function(response, opts) {
    					var obj = Ext.decode(response.responseText);
    					if (obj.success) {
    						grid.getStore().reload();
        			    	ExtApp.util.Util.showToast("删除成功！");
    			        } else {
    			        	ExtApp.util.Util.handleRequestFailure(response);
    			        }
    			    },
    				failure: function(response, opts) {
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	})
    		}
    	});
    },
    
    // 文件下载
    onFileClick: function(grid, td, rowIndex, cellIndex, e, record, tr) {
    	window.location.href = "/pdms/com/document!downloadDocument.action?"
    			+ "revisionId=" + record.data.documentRevisionId
    			+ "&documentIdxId=" + record.data.id;
    }

});
