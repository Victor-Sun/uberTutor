/**
 * 项目管理-组织(tab)Controller
 */
Ext.define('ExtApp.view.projectmanagement.org.ProjectOrganizationTabController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.projectOrganizationTab',
    
    // 点击菜单动作
    onSelectionchange: function(tree, node) {
		var refs = this.getReferences();
        var mainCard = refs.mainCardPanel;
        var lastView = mainCard.getLayout().getActiveItem();
        if (lastView != null) {
        	lastView.destroy();
        }
        if (node[0]) {
        	if (node[0].get('id') == 'root') {
        		return;
        	}
        	// 基本信息可编辑Flag
        	var infoEditFlag = true;
        	var planLevel = 1;
        	if (this.view.xtype == 'projectOrganization03' &&
        			node[0].get('obsTypeCode') == 'OBS_TYPE_RESP_DEPT') {
        		infoEditFlag = false;
        	}
        	if (this.view.xtype == 'projectOrganization03') {
        		planLevel = 2;
        	}
        	// 项目组织可编辑Flag
        	var obsEditFlg = node[0].get('obsCanEdit');
			var orgDetail = Ext.create(
					'ExtApp.view.projectmanagement.org.ProjectOrganization02',
					{programId: this.getView().programId,
					 obsId: node[0].get('id'),
					 programVehicleId: this.view.programVehicleId,
					 parentObs: node[0].get('parentObs'),
					 isRespDept: (node[0].get('obsTypeCode') == 'OBS_TYPE_RESP_DEPT'),
					 infoEditFlag: infoEditFlag,
					 editPrivilege: this.view.editPrivilege && obsEditFlg,
					 baselineId: this.view.baselineId,
					 planLevel:planLevel
					 }
				);
			orgDetail.load({
				url: '/pdms/pm/project-organization!getObsInfo.action',
				params: {
					obsId: node[0].get('id'),
					programVehicleId: this.view.programVehicleId,
					baselineId: this.view.baselineId
				}
			});
	        mainCard.add(orgDetail);
	        Ext.suspendLayouts();
	        mainCard.getLayout().setActiveItem(orgDetail);
	        Ext.resumeLayouts(true);
        }
	},
	
	// 一级组织架构点击右键
	showMenuLevelOne: function(tree, record, item, index, e, eOpts) {
		var me = this;
		e.preventDefault();  
        e.stopEvent();
    	// 项目组织可编辑Flag
    	var obsEditFlg = record.get('obsCanEdit');
		if (! (this.view.editPrivilege && obsEditFlg)) {
			return;
		}
		if (record.id == 'root') {
//			var m1 = new Ext.menu.Menu({
//				items: [{
//					text: '添加下级组织',
//					listeners: {
//						click: function() {
//							me.createObs(record, '1');
//						}
//					}
//				}]
//			});
//			m1.showAt(e.getXY());
		} else if (record.get('parentObs') == '') {
			var m1 = new Ext.menu.Menu({
				items: [{
					text: '添加下级组织',
					listeners: {
						click: function() {
							me.createObs(record, '1');
						}
					}
				}]
			});
			m1.showAt(e.getXY());
		} else if (record.get('obsTypeCode') == 'OBS_TYPE_RESP_DEPT') {
			var m1 = new Ext.menu.Menu({
				items: [{
					text: '删除组织',
					listeners: {
						click: function() {
							me.deleteObs(record, '1');
						}
					}
				}]
			});
			m1.showAt(e.getXY());
		} else {
			var m1 = new Ext.menu.Menu({
				items: [{
					text: '删除组织',
					listeners: {
						click: function() {
							me.deleteObs(record, '1');
						}
					}
				},{
					text: '添加下级组织',
					listeners: {
						click: function() {
							me.createObs(record, '1');
						}
					}
				}]
			});
			m1.showAt(e.getXY());
		}
	},
	
	// 二级组织架构点击右键
	showMenuLevelTwo: function(tree, record, item, index, e, eOpts) {
		var me = this;
		e.preventDefault();
        e.stopEvent();
    	// 项目组织可编辑Flag
    	var obsEditFlg = record.get('obsCanEdit');
		if (! (this.view.editPrivilege && obsEditFlg)) {
			return;
		}
		if (record.get('obsTypeCode') == 'OBS_TYPE_RESP_DEPT') {
			var m1 = new Ext.menu.Menu({
				items: [{
					text: '添加下级组织',
					listeners: {
						click: function() {
							me.createObs(record, '2');
						}
					}
				}]
			});
			m1.showAt(e.getXY());
		} else {
			var m1 = new Ext.menu.Menu({
				items: [{
					text: '添加下级组织',
					listeners: {
						click: function() {
							me.createObs(record, '2');
						}
					}
				},{
					text: '删除组织',
					listeners: {
						click: function() {
							me.deleteObs(record, '2');
						}
					}
				}]
			});
			m1.showAt(e.getXY());
		}
	},
	
	// 添加下级组织
	createObs: function (record, planLevel) {
		var viewObj = this.view.up('projectOrganizationTab');
    	this.dialog = viewObj.add({
    		xtype: 'createProgramObs',
    		obsId: record.get('id'),
    		planLevel: planLevel,
    		programId: viewObj.programId,
    		programVehicleId: viewObj.programVehicleId
    	});
    	this.dialog.show();
	},
	
	// 删除组织
	deleteObs: function (record, planLevel) {
		var me = this;
    	Ext.MessageBox.confirm('提示', '删除组织将删除所有关联任务，清空交付物关键活动，并设交付物为【不适用】，确认删除？', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    			me.view.mask('Please Waiting...');
    	    	Ext.Ajax.request({
    	    		url:'/pdms/pm/project-organization!deleteObsInfo.action',
    	    		params: {
    	    			obsId: record.get('id')
    				},
    				scope: me,
    				success: function(response, opts) {
    					me.view.unmask();
    			    	var obj = Ext.decode(response.responseText);
        		    	if (obj.success) {
        		    		me.view.down('treepanel').store.reload();
        					if (planLevel == '1') {
        						// 删除一级组织架构时，需要刷新二级组织Tree
            					me.view.up('projectOrganizationTab').down(
            							'projectOrganization03').down('treepanel').store.reload();
            		    		// 删除一级组织架构时，需要刷新主Tree二级计划节点
            					var projectTree = me.view.up('projectWindow').down('projectTree');
            		            var node = projectTree.getStore().getNodeById('PROGRAM_DEPT_PLAN');
            		            projectTree.getStore().getProxy().extraParams.type = 'DEPT_PLAN';
            		            projectTree.getStore().load({node: node});
            		            projectTree.getStore().on('load', function() {
            		            	node.expand();
            		            	node.collapse();
            		            });
        					}
        			    	ExtApp.util.Util.showToast("删除成功！");
        		        } else {
        		        	ExtApp.util.Util.handleRequestFailure(response);
        		        }
    			    },
    				failure: function(response, opts) {
    					me.view.unmask();
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	})
    		}
    	});
	}
});