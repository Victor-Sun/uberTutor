/**
 * 质量问题管理-待办任务-实施措施Controller
 */
Ext.define('ExtApp.view.qualityissuemanagement.qedashboard.step8.MyTaskInfo08Controller', {
    extend: 'ExtApp.view.common.IssueStepViewController',
    alias: 'controller.myTaskInfo08',
    //初期加载
    init: function() {
    	var me = this;
    	var form = this.lookupReference('refVerificationScheme05');
    	form.load({
            url:'/pdms/ims/my-task!getVerificationLine.action',
			params: {
				keyId: this.view.keyId,
	    		formKey: this.view.formKey
			},
            success: function(form,result,data) {
    			Ext.each(result.result.data, function (record) {
    				me.addPanel(record);
    			});
            }
        });
    },
    //加载验证方案
    addPanel: function (record) {
    	var refPanel = this.lookupReference('refVerificationScheme05');
		var fieldlabelIndex = refPanel.items.length + 1;
		var configItem=[{
			xtype:'fieldset',
			title:'<B>验证方案 '+ fieldlabelIndex +'</B>',
			collapsible: true,
			scrollable: true,
			layout:{
				type:'vbox'
			},
			defaults: {
				layout: 'hbox',
				defaults: {
					margin: 5
				}
			},
			items:[{
				xtype: 'container',
				items: [{
					xtype:'combo',
					fieldLabel:'验证方案 ' + fieldlabelIndex,
					readOnly:true,
					editable: false,
					bind: {
						store:'{verification}'
					},
					queryMode: 'local',
				    displayField: 'name',
				    valueField: 'id',
					name:'verification',
					value:record.verification
				},{
					xtype : 'textareafield',
					fieldLabel : '通过要求',
					readOnly: true,
					width: 560,
					name: 'passRequest',
					value:record.passRequest
				}]
			},{
				xtype: 'container',
				items: [{
					xtype:'textareafield',
					fieldLabel: '实施信息 &nbsp;<span style="color: red;">*</span>',
					allowBlank: false,
					width: 845,
					name: 'implementVehicle',
					value: record.implementVehicle
				},{
				xtype: 'textfield',
					height: 50,
					name: 'uid',
					hidden: true,
					value: record.uid
				}]
			}]
		}];
		refPanel.add(configItem[0]);
    },
	// 点击【提交】
    saveInfo: function(btn) {
    	var me = this;
    	var v_form = me.view.getForm();
    	if(v_form.isValid() == false){
    		Ext.Msg.alert('提示', "请填写必填项！！！");
    		return;
    	}
    	v_form.submit({
    		url: '/pdms/ims/my-task-info05!save.action',
			params: {
				method:'saveMyTask',
				action:'NEXT'
			},
    	    waitMsg : '正在提交数据',  
    	    waitTitle : '提示',  
    	    method : "POST",
    	    success : function(form, action) {  
    	    	var gridTask = me.getView().grid.getStore().load();
    	    	me.getView().close();
    	    },  
    	    failure : function(form, action) {
    	    	ExtApp.util.Util.handleFormFailure(action);
    	    }
    	});
    }
});