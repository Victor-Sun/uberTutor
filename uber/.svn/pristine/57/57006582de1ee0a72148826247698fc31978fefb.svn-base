/**
 * 项目管理-计划节点/活动信息
 */
Ext.define('ExtApp.view.projectmanagement.maindept.DeptPlanTaskController', {
    extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.deptPlanTask',
    
    // 初始化
    init: function() {
    	var me = this;
    	var grid = this.view.down('grid');
    	if (! this.view.editPrivilege) {
			//grid.down('toolbar').setHidden(true);
    		grid.down('toolbar').query('#btnAddNode')[0].setHidden(true);
    		grid.down('toolbar').query('#btnImportNode')[0].setHidden(true);
    		grid.down('toolbar').query('#btnBatchDeleteNode')[0].setHidden(true);
    		grid.down('toolbar').query('#btnSelResponsibleUser')[0].setHidden(true);
			// 隐藏操作栏
			if (grid.down('checkcolumn')) {
				grid.down('checkcolumn').setHidden(true);
			}
			if (grid.down('actioncolumn')) {
				grid.down('actioncolumn').setHidden(true);
			}
    	} else {
//    		// 主计划设置节点在二级计划中只能编辑负责人
//    		if (me.view.planLevel != me.view.fnPlanLevel) {
//    			var toolbar = grid.down('toolbar');
//    			toolbar.getComponent('btnAddNode').setHidden(true);
//    			toolbar.getComponent('btnImportNode').setHidden(true);
//    			toolbar.getComponent('btnBatchDeleteNode').setHidden(true);
//    			grid.down('checkcolumn').setHidden(true);
//    			grid.down('actioncolumn').setHidden(true);
//    		}
    		this.view.cellEditing = new Ext.grid.plugin.CellEditing({
                clicksToEdit: 1
            });
    		grid.addPlugin(this.view.cellEditing);
    	}
    },
	
    // 双击列表
    onCelldblclick: function(grid, td, cellIndex, record, tr, rowIndex, e, eOpts) {
    	var me = this;
    	var rec = grid.getStore().getAt(rowIndex);
    	
    	var editPrivilege4Dept = me.view.editPrivilege &&
    								(me.view.planLevel == rec.get('taskPlanLevel'))
    		
    	Ext.create({
    		xtype: 'deptPlanTaskDetail',
    		programId: me.view.programId,
    		programVehicleId: me.view.programVehicleId,
    		obsId: me.view.obsId,
    		functionId: me.view.functionId,
    		taskId: rec.get('id'),
    		taskTypeCode: rec.get('taskTypeCode'),
    		editPrivilege: editPrivilege4Dept,
    		baselineId: me.view.baselineId,
    		actionType: 'update',
    		parentCaller: me
    	}).show();
    },

    // 新建节点
    onAddNode: function(btnObj) {
    	var me = this;
    	Ext.create({
    		xtype: 'deptPlanTaskDetail',
    		programId: me.view.programId,
 			programVehicleId: me.view.programVehicleId,
    		obsId: me.view.obsId,
    		respObsId: me.view.respObsId,
    		functionId: me.view.functionId,
    		editPrivilege: true,
    		actionType: 'new',
    		parentCaller: me
    	}).show();
    },
    
    // 引用节点
    onImportNode: function() {
    	var me = this;
    	 Ext.create({
             xtype: 'deptPlanRefTask',
             programVehicleId: me.view.programVehicleId,
             obsId: me.view.obsId,
             multiSelect: true,
             parentCaller: me
         }).show();
    },
    
    // 引用节点确定
    confirmRefTask: function(selModel) {
    	var me = this;
    	if (selModel.length == 0) {
    		return;
    	}
    	var modelData = [];
    	for (var i = 0; i < selModel.length; i++) {
    		modelData.push(selModel[i].data);
    	}
    	Ext.Ajax.request({
    		url: '/pdms/pm/dept-plan!importTask.action',
    		params: {
    			functionId: me.view.functionId,
    			model: Ext.encode(modelData)
			},
			scope: me,
			success: function(response, opts) {
		    	var obj = Ext.decode(response.responseText);
		    	if (obj.success) {
		    		me.view.down('grid').getStore().reload();
		    		if (obj.data) {
		    			ExtApp.util.Util.showInfoMsg(obj.data);
		    		} else {
		    			ExtApp.util.Util.showToast("引用成功！");
		    		}
		        } else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
		    },
			failure: function(response, opts) {
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
    	})
    },
    
    // 删除节点
    deleteNode: function(grid, rowIndex) {
    	var me = this;
    	var record = grid.getStore().getAt(rowIndex);
    	
//    	// 二级计划中不允许删除主计划节点
//    	if (me.view.planLevel != record.get('taskPlanLevel')) {
//    		ExtApp.util.Util.showErrorMsg('不允许删除主计划节点！');
//    		return;
//    	}
    	
    	Ext.MessageBox.confirm('提示', '删除该条记录只删除时程表的显示信息，不会删除任务，确认删除？', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    	    	Ext.Ajax.request({
    	    		url:'/pdms/pm/dept-plan!deleteTask.action',
    	    		params: {
    	    			functionId: me.view.functionId,
    	    			taskId: record.data.id
    				},
    				scope: me,
    				success: function(response, opts) {
    			    	var obj = Ext.decode(response.responseText);
    					if (obj.success) {
    						grid.getStore().reload();
        			    	ExtApp.util.Util.showToast("删除成功！");
    			        } else {
    			        	ExtApp.util.Util.handleRequestFailure(response);
    			        }
    			    },
    				failure: function(response, opts) {
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	})
    		}
    	});
    },
    
    // 批量删除节点
    batchDeleteNode: function() {
    	var me = this;
    	if (me.view.down('grid').getSelection().length == 0) {
    		ExtApp.util.Util.showErrorMsg('请选择要批量删除的节点！');
    		return;
    	}
    	
    	// 整理
    	var grid = me.view.down('grid');
    	var selection = grid.getSelection();
    	var modelData = [];
    	for (var i = 0; i < selection.length; i++) {
//        	// 二级计划中不允许删除主计划节点
//        	if (me.view.planLevel != selection[i].get('taskPlanLevel')) {
//        		ExtApp.util.Util.showErrorMsg('不允许删除主计划节点！');
//        		return;
//        	}
    		modelData.push(selection[i].data);
    	}
    	
    	// 删除节点提交
    	Ext.MessageBox.confirm('提示', '删除选中的记录只删除时程表的显示信息，不会删除任务，确认删除?', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    			me.view.mask('Please Waiting...');
    	    	Ext.Ajax.request({
    	    		url:'/pdms/pm/dept-plan!batchDeleteTask.action',
    	    		params: {
    	    			functionId: me.view.functionId,
    	    			model: Ext.encode(modelData)
    				},
    				scope: me,
    				success: function(response, opts) {
    					me.view.unmask();
    			    	var obj = Ext.decode(response.responseText);
    					if (obj.success) {
    						grid.getStore().reload();
        			    	ExtApp.util.Util.showToast("删除成功！");
    			        } else {
    			        	ExtApp.util.Util.handleRequestFailure(response);
    			        }
    			    },
    				failure: function(response, opts) {
    					me.view.unmask();
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	})
    		}
    	});
    },

    // 选择责任人（批量添加）
    selResponsibleUser:function(btn) {
    	var me = this;
    	if (me.view.down('grid').getSelection().length == 0) {
    		ExtApp.util.Util.showErrorMsg('请选择要批量设定负责人的任务！');
    		return;
    	}
    	Ext.create({
    		 xtype: 'obsDepartment',
    		 programId: me.view.programId,
             vehicleId: me.view.programVehicleId,
             parentCaller: me
        }).show();
    },
    
    // 选择负责人确定
    confirmUser: function(value) {
		var me = this;
		var grid = me.view.down('grid');
    	var selection = grid.getSelection();
    	var modelData = [];
    	for (var i = 0; i < selection.length; i++) {
    		modelData.push(selection[i].data);
    	}
		Ext.Ajax.request({
			url:'/pdms/pm/dept-plan!updateTaskOwner.action',
			params: {
				taskOwner: value.userId,
				model: Ext.encode(modelData)
			},
			scope: me,
			success: function(response, opts) {
		    	var obj = Ext.decode(response.responseText);
		        if (obj.success) {
		        	grid.getStore().reload();
		        	ExtApp.util.Util.showToast("更新成功！");
		        } else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
		    },
			failure: function(response, opts) {
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
		})
    },
    
    // 更新负责人
    onEditTaskOwner: function(editor, context, eOpts) {
    	var me = this;
    	var modelData = [];
    	modelData.push(context.record.data);
    	Ext.Ajax.request({
			url:'/pdms/pm/dept-plan!updateTaskOwner.action',
			params: {
				taskOwner: context.record.get('taskOwnerName'),
				model: Ext.encode(modelData)
			},
			scope: me,
			success: function(response, opts) {
		    	var obj = Ext.decode(response.responseText);
		        if (obj.success) {
		        	me.view.down('grid').store.reload();
		        } else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
		    },
			failure: function(response, opts) {
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
		})
    },
    
    // 更改【显示在时程表】
    onCheckchangeIsVisible: function(checkColumn, rowIndex, checked, eOpts){
    	var me = this;
    	var record = checkColumn.up('grid').getStore().getAt(rowIndex);
//    	// 二级计划中不允许更改主计划节点
//    	if (me.view.planLevel != record.get('taskPlanLevel')) {
//    		record.reject();
//    		ExtApp.util.Util.showErrorMsg('不允许更改主计划节点！');
//    		return;
//    	}
    	me.view.mask('Please Waiting...');
    	Ext.Ajax.request({
    		url:'/pdms/pm/dept-plan!updateVisible.action',
    		params: {
    			functionId: me.view.functionId,
    			taskId: record.get('id'),
    			isVisible: checked
			},
			scope: me,
			success: function(response, opts) {
				me.view.unmask();
		    	var obj = Ext.decode(response.responseText);
		        if (obj.success) {
		        	record.commit();
		        } else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
		    },
			failure: function(response, opts) {
				me.view.unmask();
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
    	})
    },
    
    // 查询
    search: function(btn, e) {
    	var me = this;
    	me.view.mask('Please Waiting...');
    	var form = me.view.down('toolbar').down('form').getForm();
    	var store = Ext.create(
			'ExtApp.store.projectmanagement.DeptPlanTaskStore');
    	store.getProxy().extraParams = {
    		functionId: me.view.functionId,
			baselineId: me.view.baselineId,
			searchModel: Ext.encode(form.getFieldValues())
		};
    	store.load();
    	store.on('load', function() {
    		me.view.down('grid').setStore(this);
    		me.view.down('pagingtoolbar').setStore(this);
    		me.view.unmask();
    	});
    },
    
    // 重置
    reloadSearch: function() {
    	var me = this;

    	var form = this.view.down('toolbar').down('form').getForm();
    	Ext.each(form.getFields().items, function(field) {
    		if (field.xtype != 'displayfield') {
    			if (field.xtype == 'checkbox') {
    				if (field.name == 'searchTaskOwnerNull') {
    					field.setValue(false);
    				} else {
    					field.setValue(true);
    				}
        		} else {
        			field.setValue('');
        		}
    		}
		});
    	this.search();
    },
    
    // 刷新
    refreshView: function() {
    	this.view.down('grid').store.reload();
    }
});