/**
 * 项目管理-Window Controller
 */
Ext.define('ExtApp.view.projectmanagement.ProjectWindowController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.projectWindow',
    
    // 初始化
    init: function() {
    	var me = this;
    	// 项目基本信息取得
    	var model = Ext.create('ExtApp.model.projectmanagement.ProjecTreeModel');
    	Ext.Ajax.request({
    		url:'/pdms/pm/project-base-info!getProjectBaseInfo.action',
			params:{
				programId: me.view.programId
			},
			scope: me,
			success: function(response, opts) {
		    	var obj = Ext.decode(response.responseText);
				if (obj.success) {
					if (obj.data) {
						if (obj.data.hasVehicle == false) {
							// 无默认车型时为草稿
							model.set('programStauts', 'draft');
						}
						model.set('programType',obj.data.programTypeCode);
				    	me.showView('projectBaseInfoHomePage', model);
					} else {
						ExtApp.util.Util.showErrorMsg('项目不存在!');
					}
		        } else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
		    },
			failure: function(response, opts) {
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
    	});
    },
    
	// Tree节点点击
	onItemClick: function(view, record, item, index, e, eOpts) {
        var viewType = record.get('viewType');
        if (! viewType) {
        	return;
        }
        this.showView(viewType, record);
	},
    
	// 画面显示
    showView: function(view, record) {
    	var me = this;
		var refs = this.getReferences();
        var mainCard = refs.mainCardPanel;
        var lastView = mainCard.getLayout().getActiveItem();
        if (lastView != null) {
        	lastView.destroy();
        }
        
        var privilegeStore = Ext.create(
			'ExtApp.store.projectmanagement.ProjectPrivilegeStore');
		privilegeStore.getProxy().extraParams = {programId: me.view.programId};
		privilegeStore.load();
		privilegeStore.on('load', function() {
			var newView = Ext.create({
	        	xtype: view,
	        	programId: mainCard.up().programId,
	        	programVehicleId: record.get('vehicleId'),
	        	nodeId: record.get('id'),
	        	text: record.get('text'),
	        	record: record,
	        	projectPrivilege: this.data.getAt(0).data
	        });
	        mainCard.add(newView);
	        Ext.suspendLayouts();
	        mainCard.getLayout().setActiveItem(newView);
	        Ext.resumeLayouts(true);
		});
	},
	
    // 关闭
    closeWindow: function() {
    	this.view.close();
    },
    
    // 项目切换
    onClickSubMenu: function(item) {
    	var me = this;
    	var grid = me.view.grid;
    	me.closeWindow();
    	me.openWindow(item.programId, item.programCode, item.programName ,grid);
	},
	
	// 打开项目管理窗口
    openWindow: function(programId,code,programName,grid) {
    	var win = Ext.create({
    		xtype: 'projectWindow',
    		programId: programId,
			programCode: code,
			programName: programName
    	});
    	win.show();
    }
});
