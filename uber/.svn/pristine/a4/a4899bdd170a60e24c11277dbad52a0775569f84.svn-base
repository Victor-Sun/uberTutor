/**
 * 项目管理-阀门交付物-列表形式
 */
Ext.define('ExtApp.view.projectManagement.cp.PmDeliverableListController', {
    extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.pmDeliverableList',
    
    // 查询
    search: function(btn, e) {
    	var me = this;
    	me.view.mask('Please Waiting...');
    	var form = me.view.down('toolbar').down('form').getForm();
    	var store = Ext.create(
			'ExtApp.store.projectmanagement.PmDeliverableListStore');
    	store.getProxy().extraParams = {
    		programVehicleId: me.view.programVehicleId,
			searchModel: Ext.encode(form.getFieldValues())
		};
    	store.load();
    	store.on('load', function() {
    		me.view.down('grid').setStore(this);
    		me.view.down('pagingtoolbar').setStore(this);
    		me.view.unmask();
    	});
    },
    
    // 重置
    reloadSearch: function() {
    	var me = this;

    	var form = this.view.down('toolbar').down('form').getForm();
    	Ext.each(form.getFields().items, function(field) {
    		if (field.xtype != 'displayfield') {
    			if (field.xtype == 'checkbox') {
        			field.setValue(true);
        		} else {
        			field.setValue('');
        		}
    		}
		});
    	this.search();
    },
    
    // 导出
    export2Excel:function(){
    	var me = this;
    	var url = 'rpt=pm/pm_deliverable_list.brt&emitter=toxls';
    	// 查询条件
    	var params = '';
    	var form = me.view.down('toolbar').down('form').getForm();
    	// 车型ID
    	params += 'searchProgramVehicleId=' + me.view.programVehicleId + ';';
    	// 阀门
    	if (form.findField('searchTaskName').value !='') {
    		params += 'searchTaskName=' + form.findField('searchTaskName').value + ';';
    	}
    	// 负责主体
    	if (form.findField('searchObsName').value !='') {
    		params += 'searchObsName=' + form.findField('searchObsName').value + ';';
    	}
    	// 交付物代号
    	if (form.findField('searchDeliverableCode').value !='') {
    		params += 'searchDeliverableCode=' + form.findField('searchDeliverableCode').value + ';';
    	}
    	// 交付物名称
    	if (form.findField('searchDeliverableName').value !='') {
    		params += 'searchDeliverableName=' + form.findField('searchDeliverableName').value + ';';
    	}
    	// 完成状况
    	var statusCode = "";
    	if (form.findField('searchStatus_1').checked) {
    		statusCode += "'TASK_PROGRESS_STATUS_GREY'";
    	}
    	if (form.findField('searchStatus_2').checked) {
    		if (statusCode.length > 0) {
    			statusCode += ",";
    		}
    		statusCode += "'TASK_PROGRESS_STATUS_G'";
    	}
    	if (form.findField('searchStatus_3').checked) {
    		if (statusCode.length > 0) {
    			statusCode += ",";
    		}
    		statusCode += "'TASK_PROGRESS_STATUS_GY'";
    	}
    	if (form.findField('searchStatus_4').checked) {
    		if (statusCode.length > 0) {
    			statusCode += ",";
    		}
    		statusCode += "'TASK_PROGRESS_STATUS_Y'";
    	}
    	if (form.findField('searchStatus_5').checked) {
    		if (statusCode.length > 0) {
    			statusCode += ",";
    		}
    		statusCode += "'TASK_PROGRESS_STATUS_R'";
    	}
    	if (form.findField('searchStatus_6').checked) {
    		if (statusCode.length > 0) {
    			statusCode += ",";
    		}
    		statusCode += "'TASK_PROGRESS_STATUS_B'";
    	}
    	if (statusCode.length > 0) {
    		params += 'searchProgressStatus=' + statusCode + ';';
    	}
    	// 适用
    	if (form.findField('searchIsFit').checked &&
    			! form.findField('searchIsNotFit').checked) {
    		params += 'searchIsFit=Y;';
    	} else if (! form.findField('searchIsFit').checked &&
    					form.findField('searchIsNotFit').checked) {
    		params += 'searchIsFit=N;';
    	}
    	if (params.length > 0) {
    		url += '&params=' + params;
    	}
    	ExtApp.util.Util.openReport(url);
    }
});
