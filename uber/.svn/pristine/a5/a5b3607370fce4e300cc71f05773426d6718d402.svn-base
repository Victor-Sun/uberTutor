/**
 * 项目管理-项目列表Controller
 */
Ext.define('ExtApp.view.projectmanagement.list.ProjectListController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.projectList',
    
    // 右键菜单
    onCellcontext: function(grid , td , cellIndex , record , tr , rowIndex , e , eOpts) {
    	e.preventDefault();  
        e.stopEvent();
        
        var me = this;
        var actionMenu = new Ext.menu.Menu({
        	grid: grid,
        	rowIndex: rowIndex,
        	cellIndex: cellIndex,
        	
			items: [{
				text: '删除',
				itemId: 'BTNDelete',
				iconCls: 'x-fa fa-remove'
//			},{
//				text: '冻结',
//				iconCls: 'x-fa fa-pause'
//			},{
//				text: '结题',
//				iconCls: 'x-fa fa-stop'
			}],
			listeners:{
				click: function(menu , item , e , eOpts) {
					if (item.itemId == "BTNDelete") {
						me.deleteProgram(grid, rowIndex, cellIndex);
					}
			    }
			}
		});
        actionMenu.showAt(e.getXY());
    },
    
    // 双击
    onCelldblclick: function(grid , td , cellIndex , record , tr , rowIndex , e , eOpts) {
    	var rec = grid.getStore().getAt(rowIndex);
    	this.openWindow(rec.get('id'), rec.get('code'),grid,rec.get('programName'));
    },
    
    // 打开窗体
    openWindow: function(programId, code,grid,programName) {
    	var win = Ext.create({
    		xtype: 'projectWindow',
    		programId: programId,
			programCode: code,
			programName:programName
    	});
    	win.show();
    },
    
    // 查询
    search: function(btn, e) {
    	var me = this;
    	me.view.mask('Please Waiting...');
    	var toolbar = this.view.down('toolbar');
    	var usualProject = toolbar.getComponent('searchUsualProject').getValue()['usualProject'];
    	var searchProjectCode = toolbar.getComponent('searchProjectCode').value;
    	var store = Ext.create(
			'ExtApp.store.projectmanagement.ProjectListStore');
    	store.getProxy().extraParams = {
    		usualProject: usualProject,
    		searchProjectCode: searchProjectCode
    	};
    	store.load();
    	store.on('load', function() {
    		me.view.down('grid').setStore(this);
    		me.view.down('pagingtoolbar').setStore(this);
    		me.view.unmask();
    	});
    },
    
    // 重置
    reloadSearch: function() {
    	var toolbar = this.view.down('toolbar');
    	toolbar.getComponent('searchUsualProject').setValue({
    		usualProject: '1'
    	});
    	toolbar.getComponent('searchProjectCode').setValue('');
    	this.search();
    },
    
    // 新建
    newProject: function(btn, e) {
    	var me = this;
    	Ext.create({
    		xtype: 'createProject',
    		parentCaller: me
    	}).show();
    },
    
    // 刷新列表
    refreshView: function() {
    	this.view.down('grid').store.reload();
    },

    //常用项目选择
    usualProjectChang:  function ( me , newValue , oldValue , eOpts ) {
    	if (oldValue == null) {
    		return;
    	}
    	var gridStore = me.up('grid');
    	var store = Ext.create(
			'ExtApp.store.projectmanagement.ProjectListStore');
    	store.getProxy().extraParams = {
    		usualProject: newValue
    	};
    	store.load();
    	store.on('load', function() {
    		gridStore.setStore(this);
    	});
	},
	
    // 项目排序
    projectSort: function() {
    	var me = this;
    	Ext.create({
    		xtype: 'projectSort',
    		parentCaller: me
    	}).show();
    },
    
    // 项目排序-确定
    refreshView: function() {
    	this.view.down('grid').store.reload();
    },

    //删除项目
	deleteProgram: function (grid, rowIndex, cellIndex, me) {
		var me = this;
		var record = grid.getStore().getAt(rowIndex);
    	Ext.MessageBox.confirm('提示', '您确定要删除该条记录吗?', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    			me.view.mask('Please Waiting...');
    	    	Ext.Ajax.request({
    	    		url:'/pdms/pm/project-list!deleteProgram.action',
    	    		params: {
    	    			programId: record.data.id
    				},
    				scope: me,
    				success: function(response, opts) {
    					me.view.unmask();
    					var obj = Ext.decode(response.responseText);
    					if (obj.success) {
    						grid.getStore().reload();
        			    	ExtApp.util.Util.showToast("删除成功！");
    			        } else {
    			        	ExtApp.util.Util.handleRequestFailure(response);
    			        }
    			    },
    				failure: function(response, opts) {
    					me.view.unmask();
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	});
    		}
    	});
    },
    
    //导出
    exportProjectList: function() {
    	var me = this;
    	var loginUser = "";
    	var toolbar = this.view.down('toolbar');
    	var usualProject = toolbar.getComponent('searchUsualProject').getValue()['usualProject'];
    	if ("2"== usualProject) {
    		loginUser = me.view.loginUserStore.data.getAt(0).data.userId;
    	}
    	var searchProjectCode = toolbar.getComponent('searchProjectCode').value;
    	ExtApp.util.Util.openReport('rpt=pm/projectListReport.brt&xlsbtn&params=searchProjectCode='
    			+ searchProjectCode + ';loginUser=' + loginUser);
    }
});
