/**
 * 时程表泳道设定-泳道设定
 */
Ext.define('ExtApp.view.projectmanagement.timeline.setting.TimeLineSettingController', {
    extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.timeLineSetting',
    
    // 初始化
    init: function() {
    	var grid = this.view.down('grid');
    	this.view.rowEditing = new Ext.grid.plugin.RowEditing({
            clicksToEdit: 2
        });
		grid.addPlugin(this.view.rowEditing);
    },
    
    // 点击列表数据
    onCellclick: function(grid, td, cellIndex, record, tr, rowIndex, e, eOpts) {
    	var rec = grid.getStore().getAt(rowIndex);
    	var refPanel = this.lookupReference('refTimeLineTask');
    	if (refPanel.items.getCount() > 0) {
    		var p4remove = refPanel.items.get(0);
    		refPanel.remove(p4remove);
    	}
    	var newView = Ext.create({
    		xtype: 'timeLineTask',
        	functionId: rec.get('id'),
        	childObsId: rec.get('childObsId')
        });
    	newView.down('fieldset').setTitle("节点信息-" + rec.get('displayName'));
    	refPanel.add(newView);
    },
    
    // 添加泳道
    onAddLane: function(btnObj) {
    	var me = this;
    	Ext.create({
    		xtype: 'addLane',
    		programId: me.view.programId,
			vehicleId: me.view.vehicleId,
			parentObsId: me.view.obsId,
			parentCaller: me
    	}).show();
    },
    
    // 编辑泳道
    onEditLane: function(editor, context, eOpts) {
    	var me = this;
    	Ext.Ajax.request({
    		url: '/pdms/pm/time-line-setting!updateLane.action',
    		params: {
    			programId: me.view.programId,
    			vehicleId: this.view.vehicleId,
    			parentObsId: this.view.obsId,
    			model: Ext.encode(context.record.data)
			},
			scope: me,
			success: function(response, opts) {
				var obj = Ext.decode(response.responseText);
				if (obj.success) {
					context.record.commit();
			    	ExtApp.util.Util.showToast("修改成功！");
		        } else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
		    },
			failure: function(response, opts) {
		    	ExtApp.util.Util.handleRequestFailure(response);	
		    }
    	})
    },
    
    // 删除泳道
    deleteLane: function(grid, rowIndex) {
    	var me = this;
    	var record = grid.getStore().getAt(rowIndex);
    	Ext.MessageBox.confirm('提示', '您确定要删除该条记录吗?', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    	    	Ext.Ajax.request({
    	    		url:'/pdms/pm/time-line-setting!deleteLane.action',
    	    		params: {
    	    			functionId: record.data.id
    				},
    				scope: me,
    				success: function(response, opts) {
    			    	var obj = Ext.decode(response.responseText);
    					if (obj.success) {
    						grid.getStore().reload();
        			    	ExtApp.util.Util.showToast("删除成功！");
    			        } else {
    			        	ExtApp.util.Util.handleRequestFailure(response);
    			        }
    			    },
    				failure: function(response, opts) {
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	})
    		}
    	});
    },
    
    // 取消更新
    onCanceledit: function(editor, context, eOpts) {
    	var id = context.record.data.id;
    	if (id.indexOf('projectmanagement') != -1) {
    		// 新增记录时，如果取消，则需要删除增加的空行
    		context.grid.getStore().removeAt(context.rowIdx);
    	}
    },
    
    // 确定
    confirm: function() {
    	var obj = this.view.parentCaller.view.down('timelinepanel');
    	obj.resourceStore.reload();
    	obj.eventStore.reload();
    	this.view.close();
    },
    
    // 刷新
    refreshView: function() {
    	this.view.down('grid').store.reload();
    }

});