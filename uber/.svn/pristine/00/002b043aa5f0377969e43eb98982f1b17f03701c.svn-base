/**
 * 质量问题管理-提交问题-知会Controller
 */
Ext.define('ExtApp.view.qualityissuemanagement.qedashboard.ForumMemberController',{
    extend: 'Ext.app.ViewController',
    alias: 'controller.forumMember',
	// 点击【增加】
    addMember: function() {
    	var me = this;
    	if(me.getView().sourceId == null){
    		var v_form_sub = me.view.up().up('form');
        	var v_form = v_form_sub.getForm();
        	v_form_sub.lookupController().setAllowBlank(v_form,true);
        	v_form.submit({
        		url: '/pdms/ims/ims-issue!save.action',
                params: {
                	model: Ext.encode(v_form.getFieldValues()),
                	keyId: me.view.keyId,
                	taskId: me.view.taskId,
                	ProcessInstanceId: me.view.ProcessInstanceId,
                	method:'updateIssue',
                	action:'SAVE'
                },
                scope: this,
        	    success : function(form, action) {
     		    	v_form_sub.keyId = action.result.data;
     		    	v_form.findField('id').setValue(action.result.data);
     		    	me.view.sourceId = action.result.data;
     		    	
        	    },
        	    failure: function(form, action) {
        	    	ExtApp.util.Util.handleFormFailure(action);
        	    }
        	});
    	}else{
    		Ext.create({
		    		xtype: 'sysUserDepartment',
		    		title: '知会',
		    		multiSelect: true,
		    		parentCaller: me
		    	}).show();
    	}
    	
    	
    },
    onResetClick: function(){
    	var me = this;
        this.view.down('grid').getStore().load({params:{issueId:me.getView().sourceId}});
    },
    // 添加用户/选择专业经理 - 确定
    confirmUser: function(userData) {
		var grid = this.view.down('grid');
    	var me = this;
    	var modelData = [];
    	for (var i = 0; i <userData.length; i++) {
    		modelData.push(userData[i].data);
    	}
    	Ext.Ajax.request({
    		url:'/pdms/ims/ims-dashboard!addMember.action',
			scope: me,
			params:{issueId:me.view.sourceId,modelData:Ext.encode(modelData)},
			success: function(response, opts) {
		    	var obj = Ext.decode(response.responseText);
				if (obj.success) {
					var intId = grid.getStore().getCount();

			    	Ext.each(modelData, function (record) {
			    		var valId = record.id;
			    		var valName = record.name;

			    		var gridStore = grid.getStore();
			    		if (gridStore.find('userName', valId) == -1) {
			        		if (intId != 0) {
			        			intId = intId + 1;
			        		}
			    			gridStore.insert(intId, {
				    			id : valId,
				    			userName : valName,
				    			createDate:new Date()
			        		});
			    		} else {
			    	    	ExtApp.util.Util.showToast(Ext.String.format('员工['+valName+']已选择!.........'));
			    		}
					});
				} else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
		    },
			failure: function(response, opts) {
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
    	});
		
	}
});