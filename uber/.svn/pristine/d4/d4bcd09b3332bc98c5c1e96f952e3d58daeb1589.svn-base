/**
 * 质量问题管理-问题着陆道报表
 */
Ext.define('ExtApp.view.qualityissuemanagement.report.TrendReportController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.trendReport',

    // 初始化
    init: function() {
    	this.displayReport();
    },
    
    // 查询
    search: function() {
    	var toolbar = this.view.down('toolbar');
    	// 所属项目
    	var programId = toolbar.query('#searchProgram')[0].value;
    	// 所属子项目
    	var programVehicleId = toolbar.query('#searchProgramVehicle')[0].value;
    	// 责任部门
    	var deptId = toolbar.query('#searchDept')[0].value;
    	// 周期From
    	var dateFrom = toolbar.query('#searchDateFrom')[0].rawValue;
    	// 周期To
    	var dateTo = toolbar.query('#searchDateTo')[0].rawValue;
    	// 周期间隔
    	var interval = toolbar.query('#searchInterval')[0].value;
    	if(interval < 0){
    		Ext.Msg.alert('提示', '周期间隔必须大于0！');
    		return;
    	}
    	
    	// 查询
    	this.displayReport(programId, programVehicleId, deptId, dateFrom, dateTo, interval);
    },
    
    // 重置
    reload: function() {
    	var toolbar = this.view.down('toolbar');
    	toolbar.query('#searchDept')[0].setValue(null);
    	toolbar.query('#searchProgramVehicle')[0].setValue(null);
    	toolbar.query('#searchProgram')[0].setValue(null);
    	toolbar.query('#searchDateFrom')[0].setValue(null);
    	toolbar.query('#searchDateTo')[0].setValue(null);
    	toolbar.query('#searchInterval')[0].setValue(null);
    	this.displayReport();
    },
    
    // 显示报表
    displayReport: function(programId, programVehicleId, deptId, dateFrom, dateTo, interval) {
    	var me = this;
    	var refPanel = this.lookupReference('refTrendReport');
    	if (refPanel.items.getCount() > 0) {
    		var p4remove = refPanel.items.get(0);
    		refPanel.remove(p4remove);
    	}
    	var param = '';
    	if (programId && programId != null && programId != '') {
    		param += '&params=pg_id=' + programId + ';';
    	}
    	if (programVehicleId && programVehicleId != null && programVehicleId != '') {
    		if (param == '') {
    			param += '&params=pv_id=' + programVehicleId + ';';
    		} else {
    			param += 'pv_id=' + programVehicleId + ';';
    		}
    	}
    	if (deptId && deptId != null && deptId != '') {
    		if (param == '') {
    			param += '&params=dept_id=' + deptId + ';';
    		} else {
    			param += 'dept_id=' + deptId + ';';
    		}
    	}
    	if (dateFrom && dateFrom != null && dateFrom != '') {
    		if (param == '') {
    			param += '&params=date_from=' + dateFrom + ';';
    		} else {
    			param += 'date_from=' + dateFrom + ';';
    		}
    	}
    	if (dateTo && dateTo != null && dateTo != '') {
    		if (param == '') {
    			param += '&params=date_to=' + dateTo + ';';
    		} else {
    			param += 'date_to=' + dateTo + ';';
    		}
    	}
    	if (interval && interval != null && interval != '') {
    		if (param == '') {
    			param += '&params=interval=' + interval + ';';
    		} else {
    			param += 'interval=' + interval + ';';
    		}
    	}

    	Ext.Ajax.request({
    		url:'/pdms/com/report!getReportAddress.action',
			scope: me,
			success: function(response, opts) {
		    	var obj = Ext.decode(response.responseText);
				if (obj.success) {
					if (obj.data.reportAddress) {
						var configItem=[{
				    		xtype: 'component', 
					    	layout: 'fit',
							autoEl:{
								tag:'iframe',
								id:'#scaleframe',
								border:0,
								frameborder:"no", 
								src:obj.data.reportAddress + '/report/ReportEmitter?rpt=ims/ims_trend_report.brt&fitwidth=true&xlsbtn;' + param,
								scrolling:'yes'
							}
						}];
						refPanel.add(configItem[0]);
					} else {
						ExtApp.util.Util.showErrorMsg('不能获取报表Server的地址！');
					}
		        } else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
		    },
			failure: function(response, opts) {
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
    	})
    }
});