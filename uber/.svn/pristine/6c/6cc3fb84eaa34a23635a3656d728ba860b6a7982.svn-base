/**
 * 项目管理-主节点
 */
Ext.define('ExtApp.view.projectmanagement.mainnode.ProjectPlanMainNodeController', {
    extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.projectPlanMainNode',
 
    // 初始化
    init: function() {
    	var me = this;
    	if (me.view.xtype == 'projectPlanMainNode02') {
    	    if (me.view.editPrivilege) {
    	    	me.view.rowEditing = new Ext.grid.plugin.RowEditing({
    	            clicksToEdit: 2
    	        });
    	    	me.view.down('grid').addPlugin(me.view.rowEditing);
    	    }
    	} else if (me.view.xtype == 'projectPlanMainNode') {
    		var grid = me.view.lookupReference('refPlanMainNodeGrid')
    		if (! me.view.editPrivilege) {
    			grid.down('toolbar').setHidden(true);
        		// 隐藏操作栏
        		grid.down('actioncolumn').setHidden(true);
    		} else {
    			me.view.rowEditing = new Ext.grid.plugin.RowEditing({
    	            clicksToEdit: 2
    	        });
    			grid.addPlugin(me.view.rowEditing);
    		}
    	}
    },
    
    // 添加节点
    addNode: function(btnObj) {
    	var me = this;
    	Ext.create({
    		xtype: 'mainNodeInfo',
    		programId: this.view.programId,
			programVehicleId: this.view.programVehicleId,
			parentCaller: me
    	}).show();
    },
    
    // 删除节点
    deleteNode: function(grid, rowIndex) {
    	var me = this;
    	var record = grid.getStore().getAt(rowIndex);
    	Ext.MessageBox.confirm('提示', '您确定要删除该条记录吗?', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    			me.view.mask('Please Waiting...');
    	    	Ext.Ajax.request({
    	    		url:'/pdms/pm/project-plan-major-node!deleteNode.action',
    	    		params: {
    	    			programVehicleId: me.view.programVehicleId,
    	    			taskId: record.data.id
    				},
    				scope: me,
    				success: function(response, opts) {
    					me.view.unmask();
    					var obj = Ext.decode(response.responseText);
    					if (obj.success) {
    						grid.getStore().reload();
        			    	ExtApp.util.Util.showToast("删除成功！");
    			        } else {
    			        	ExtApp.util.Util.handleRequestFailure(response);
    			        }
    			    },
    				failure: function(response, opts) {
    					me.view.unmask();
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	});
    		}
    	});
    },
    
    // 更新节点信息
    onEdit: function(editor, context, eOpts) {
    	var me = this;
    	me.view.mask('Please Waiting...');
    	Ext.Ajax.request({
    		url: '/pdms/pm/project-plan-major-node!updateMainNode.action',
    		params: {
    			programVehicleId: me.view.programVehicleId,
    			model: Ext.encode(context.record.data)
			},
			scope: me,
			success: function(response, opts) {
				me.view.unmask();
				var obj = Ext.decode(response.responseText);
		        if (obj.success) {
		        	me.refreshView();
			    	ExtApp.util.Util.showToast("更新成功！");
		        } else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
		    },
			failure: function(response, opts) {
				me.view.unmask();
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
    	});
    },
    
    // 刷新页面
    refreshView: function() {
    	var grid = this.lookupReference('refPlanMainNodeGrid')
    	grid.store.reload();
    }
});