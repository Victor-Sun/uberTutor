/**
 * 附件列表
 */
Ext.define('ExtApp.view.common.upload.FileAttachmentController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.fileAttachment',

	// 上传附件
    uploadFile: function() {
    	var me = this;
    	Ext.create({
    		xtype: 'fileUpload',
    		programId: me.view.programId,
    		sourceType: me.view.sourceType,
    		sourceId: me.view.sourceId,
    		parentCaller: me
    	}).show();
    },
    
    // 上传附件-确定
    confirmUpload: function() {
    	this.view.store.reload();
    	if (this.view.parentCallerView) {
    		this.view.up(this.view.parentCallerView).controller.uploadFileCallBack();
    	}
    },
    
    // 删除附件
    deleteFile: function(grid, rowIndex) {
    	var me = this;
    	var record = grid.getStore().getAt(rowIndex);
    	Ext.MessageBox.confirm('提示', '您确定要删除该条记录吗?', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    	    	Ext.Ajax.request({
    	    		url:'/pdms/com/document!deleteDocument.action',
    	    		params: {
    	    			documentIdxId: record.data.id
    				},
    				scope: me,
    				success: function(response, opts) {
    					var obj = Ext.decode(response.responseText);
    					if (obj.success) {
    						grid.getStore().reload();
        			    	ExtApp.util.Util.showToast("删除成功！");
        			    	if (me.view.parentCallerView) {
        			    		me.view.up(me.view.parentCallerView).controller.deleteFileCallBack();
        			    	}
    			        } else {
    			        	ExtApp.util.Util.handleRequestFailure(response);
    			        }
    			    },
    				failure: function(response, opts) {
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	})
    		}
    	});
    },
    
    // 文件下载
    onFileClick: function(grid, td, rowIndex, cellIndex, e, record, tr) {
    	window.location.href = "/pdms/com/document!downloadDocument.action?"
    			+ "revisionId=" + record.data.documentRevisionId
    			+ "&documentIdxId=" + record.data.id;
    }

});
