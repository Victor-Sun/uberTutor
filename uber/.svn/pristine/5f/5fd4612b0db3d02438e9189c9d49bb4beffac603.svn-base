/**
 * 项目管理-基本信息Controller
 */
Ext.define('ExtApp.view.projectmanagement.base.ProjectBaseInfo02Controller', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.projectBaseInfo02',

    // 初始化
    init: function() {
    	var grid = this.view.down('grid');
    	if (! this.view.editPrivilege) {
			grid.down('toolbar').setHidden(true);
			// 隐藏操作栏
			grid.down('actioncolumn').setHidden(true);
    	} else {
    		this.view.rowEditing = new Ext.grid.plugin.RowEditing({
	            clicksToEdit: 2
	        });
    		grid.addPlugin(this.view.rowEditing);
    	}
    },
    
    // 添加车型
    addVehicle: function(btnObj) {
        var me = this;
    	Ext.Ajax.request({
    		url:'/pdms/pm/project-base-info!getProjectBaseInfo.action',
			scope: me,
			params: {programId: me.view.programId},
			success: function(response, opts) {
		    	var obj = Ext.decode(response.responseText);
				if (obj.success) {
					if (obj.data) {
						this.view.add({
				            xtype: 'createVehicle',
				            programId: me.view.programId,
				            pm: obj.data.pm,
				            pmName: obj.data.pmName,
				            qm: obj.data.qm,
				            qmName: obj.data.qmName
				        }).show();
					} else {
						ExtApp.util.Util.showErrorMsg('项目不存在!');
					}
		        } else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
		    },
			failure: function(response, opts) {
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
    	});
    },
    
    // 删除车型
    deleteVehicle: function(grid, rowIndex) {
    	var me = this;
    	var record = grid.getStore().getAt(rowIndex);
    	Ext.MessageBox.confirm('提示', '您确定要删除该条记录吗?', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    	    	Ext.Ajax.request({
    	    		url:'/pdms/pm/project-base-info!deleteVehicle.action',
    	    		params: {
    	    			vehicleId: record.data.id
    				},
    				scope: me,
    				success: function(response, opts) {
    					var obj = Ext.decode(response.responseText);
    	    	        if (obj.success) {
    	    	        	grid.getStore().reload();
        			    	ExtApp.util.Util.showToast("删除成功！");
            		    	// 刷新项目管理Tree
            		    	var tree = me.view.up('projectWindow').down('projectTree');
            		    	var node = tree.getStore().getNodeById(me.view.programId);
            		    	tree.getStore().getProxy().extraParams.type = 'PROGRAM';
            		        tree.getStore().load({node:node});
    	    	        } else {
    	    	        	ExtApp.util.Util.handleRequestFailure(response);
    	    	        }
    			    },
    				failure: function(response, opts) {
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	})
    		}
    	});
    },
    
    // 更新车型信息
    onEdit: function(editor, context, eOpts) {
    	var me = this;
    	Ext.Ajax.request({
    		url: '/pdms/pm/project-base-info!updateVehicle.action',
    		params: {
    			programId: me.view.programId,
    			model: Ext.encode(context.record.data)
			},
			scope: me,
			success: function(response, opts) {
				var obj = Ext.decode(response.responseText);
    	        if (obj.success) {
    	        	context.record.commit();
    		    	context.grid.getStore().reload();
    		    	ExtApp.util.Util.showToast("提交成功！");
    		    	// 刷新项目管理Tree
    		    	var tree = me.view.up('projectWindow').down('projectTree');
    		    	var node = tree.getStore().getNodeById(me.view.programId);
    		    	tree.getStore().getProxy().extraParams.type = 'PROGRAM';
    		        tree.getStore().load({node:node});
    	        } else {
    	        	ExtApp.util.Util.handleRequestFailure(response);
    	        }
		    },
			failure: function(response, opts) {
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
    	})
    },
    
    // 取消更新
    onCanceledit: function(editor, context, eOpts) {
    	var id = context.record.data.id;
    	if (id.indexOf('projectmanagement') != -1) {
    		// 新增记录时，如果取消，则需要删除增加的空行
    		context.grid.getStore().removeAt(context.rowIdx);
    	}
    }
});
