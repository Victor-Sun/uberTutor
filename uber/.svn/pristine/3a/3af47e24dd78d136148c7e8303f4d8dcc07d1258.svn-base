/**
 * 系统设定-项目角色管理
 */
Ext.define('ExtApp.view.systemsettings.projectmanager.rolemanager.RoleManagerController', {
    extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.roleManager',

    // 添加角色
    addNode: function(btnObj) {
    	var grid = btnObj.up('panel').down('grid');
    	var gridStore = btnObj.up('panel').down('grid').getStore();
    	var model = Ext.create(
    			'ExtApp.model.systemsettings.ProjectrolemanagerModel');
    	gridStore.insert(0, model);
    	grid.getPlugin().startEdit(0);
    },
    
    // 删除角色
    deleteNode: function(grid, rowIndex) {
    	var me = this;
    	var record = grid.getStore().getAt(rowIndex);
    	if (record.data.systemFlag == 'Y'){
    		 ExtApp.util.Util.showErrorMsg('不允许删除系统角色!');
    	} else {
    		Ext.MessageBox.confirm('提示', '您确定要删除该条记录吗?', function(btn) {
        		// 提示信息点击【YES】则删除
        		if (btn == 'yes') {
        	    	Ext.Ajax.request({
        	    		url:'/pdms/sys/projectmanager!deleteProjectrolemanager.action',
        	    		params: {
        	    			sysId: record.data.id
        				},
        				scope: me,
        				success: function(response, opts) {
//        					me.view.query('#gridItemsId')[0].getStore().reload();
        					grid.getStore().reload();
        					
        			    	ExtApp.util.Util.showToast("删除成功！");
        			    },
        				failure: function(response, opts) {
        			    	ExtApp.util.Util.handleRequestFailure(response);
        			    }
        	    	})
        		}
        	});
    	}
    },

	// 更新角色信息
    roleEditChange: function(editor, context, eOpts) {
    	var url = '/pdms/sys/projectmanager!updateProjectrolemanager.action';
    	var id = context.record.data.id;
    	if (id.indexOf('systemsettings') != -1) {
    		var url = '/pdms/sys/projectmanager!insertProjectrolemanager.action';
    	}
    	var me = this;
    	Ext.Ajax.request({
    		url:url,
    		params: {
    			id:context.record.data.id,
    			editModel: Ext.encode(context.newValues)
			},
			scope: me,
			success: function(response, opts) {
				context.grid.getStore().reload();
		    	ExtApp.util.Util.showToast("提交成功！");
		    },
			failure: function(response, opts) {
		    	ExtApp.util.Util.handleRequestFailure(response);	
		    }
    	})
    },
    
    // 取消更新
    onCanceledit: function(editor, context, eOpts) {
    	var id = context.record.data.id;
    	if (id.indexOf('systemsettings') != -1) {
    		// 新增记录时，如果取消，则需要删除增加的空行
    		context.grid.getStore().removeAt(context.rowIdx);
    	}
    },
    
 // 默认项目角色编辑
    onChange: function(grid , td , cellIndex , record , tr , rowIndex , e , eOpts) {
    	var me = this;
    	var record = grid.getStore().getAt(cellIndex);
    	if (record.id == '7692EC0BD4A344DDB763955858E8174A' ||
    			record.id == 'AF361385A7F144A696CC5C98F7D1419F' ||
    			record.id == 'FFD578E366BA46AEBA0DA21AA9CD6DAA' ||
    			record.id == 'E57DB49C98DD41E9ADD79E0AD77B89AD') {
    		ExtApp.util.Util.showErrorMsg('不允许设定该角色为默认角色!');
    		return;
    	}
    	Ext.MessageBox.confirm('提示', '您确定要设定默认项目角色吗?', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    	    	Ext.Ajax.request({
    	    		url:'/pdms/sys/projectmanager!editeProProjectrolemanager.action',
    	    		params: {
    	    			sysId: record.id
    				},
    				scope: me,
    				success: function(response, opts) {
    					grid.getStore().reload();
    			    	ExtApp.util.Util.showToast("设定成功！");
    			    },
    				failure: function(response, opts) {
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	})
    		}
    	});
    },
    // 权限一览
    selectRecord: function(grid , record , index , eOpts){
    	var me = this;
    	me.view.profileId = record.id;
    	var v_grid = grid.view.up('projectrolemanager').down('permissionMenu');
    	var store = Ext.create('ExtApp.store.projectmanagement.PermissionMenus');
		store.getProxy().extraParams = {
			profileId: record.id
		};
		store.load();
		v_grid.setStore(store);
		
    },
    
    // 权限变更
    onCheckChange: function(The, rowIndex, checked, e, eOpts){
    	var grid = this.view.query('#gridItemsId')[0];
    	var rec = grid.getStore().getAt(rowIndex);
    	if (checked == true){
    		var allowFlag = 'Y';
    	} else {
    		var allowFlag = 'N';
    	}
    	
    	Ext.Ajax.request({
    		url:'/pdms/sys/projectmanager!editeProjectrolemanagerPower.action',
    		params: {
    			sysId: rec.id,
    			allowFlag: allowFlag
			},
			scope: me,
			success: function(response, opts) {
				//grid.getStore().reload();
		    	//ExtApp.util.Util.showToast("设定成功！");
				rec.commit();
		    },
			failure: function(response, opts) {
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
    	})
    },
    savePermission:function(){
    	var me = this;
    	var records = me.view.down('permissionMenu').getChecked();
    	var modelData = [];
    	for (var i = 0; i < records.length; i++) {
    		modelData.push(records[i].data);
    	}
    	Ext.Ajax.request({
    		 url: '/pdms/sys/projectmanager!savePermission.action',
    		 params:{
    			 editModel: Ext.encode(modelData),
    			 profileId:me.view.profileId
    		 },
    	     success: function(response, opts) {
    	    	 var result = ExtApp.util.Util.decodeJSON(response.responseText);
    	 		 if (!result){ //#4
	    	 		 result = {};
	    	 		 result.success = false;
	    	 		 result.msg = response.responseText;
    	 		 }
    	 		window.close();
    	     },
    	     failure: function(response, opts) {
    	    	 var result = ExtApp.util.Util.decodeJSON(response.responseText);           	 		 
    	     }
    	 });
    }
});