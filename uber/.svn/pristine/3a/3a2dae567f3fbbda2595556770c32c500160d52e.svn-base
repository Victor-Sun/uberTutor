/**
 * 个人管理-待办任务-Open IssueView
 */
Ext.define('ExtApp.view.myworkspace.TodoListOpenIssue',{
	extend:'Ext.tab.Panel',
	xtype:'todoListOpenIssue',
	controller: 'todoListOpenIssue',
	title:'Open Issue',
	layout:'fit',
	initComponent: function() {
		var me = this;
		
		var totalStore = Ext.create('ExtApp.store.myworkspace.TodoListOpenIssueStore');
		totalStore.load();
		totalStore.on('load',function() {
			me.setTitle('项目 Open Issue<font color="red"><b>（' + this.getTotalCount() + '）</b></font>');   
		});
		
		// 列表Store
		var todoListOpenIssueStore = Ext.create('ExtApp.store.myworkspace.TodoListOpenIssueStore');
		todoListOpenIssueStore.load();
		todoListOpenIssueStore.on('beforeload', function() {
			var form = me.down('toolbar').down('form').getForm();
			this.getProxy().extraParams = {
				searchModel: Ext.encode(form.getFieldValues())
			};
    	});
		
		// 平台项目
		var programStore = Ext.create('ExtApp.store.projectmanagement.AllProgramStore');
		programStore.load();
		// 车型
		var vehicleStore = Ext.create('ExtApp.store.projectmanagement.AllVehicleByProgramStore');
		
		this.items = [{
			title: '列表',
			xtype: 'panel',
			layout: 'border',
			items: [{
				xtype:'grid',
				region: 'center',
				title: '问题列表',
				reference: 'refTodoListOpenIssueGrid',
				selModel: 'checkboxmodel',
				store: todoListOpenIssueStore,
				columns:[{
					text: '进度状态',
					width: 100,
					dataIndex: 'progressStatus',
					renderer: 'renderIssueProgress',
					align: 'center'
				},{
					text: '问题标题',
					flex: 1,
					dataIndex: 'title'
				},{
					text: '最近更新时间',
		    		dataIndex:'lastUpdateDate',
		    		formatter: 'date("Y/m/d H:i:s")',
		    		width: 120,
		    		filter: {
			        	type: 'date'
			        }
				},{
					text:'延期天数',
					dataIndex:'daysLate',
					width: 100
				},{
					text:'优先级',
					dataIndex:'issuePriorityName', 
					width: 100
				}],
				listeners:{
		        	selectionchange: 'onSelectionChange',
		        	itemdblclick: 'itemdblclick'
				},
				dockedItems: [{
				     xtype: 'pagingtoolbar',
				     dock: 'bottom',
				     displayInfo: true,
				     store: todoListOpenIssueStore
				}]
			},{
				xtype: 'form',
				itemId: 'detailForm',
				collapsible: true,
				region: 'east',
				width: '33%',
				split: true,
				scrollable: true,
				title: '问题信息',
//				layout: 'fit',
				items: [{
					xtype: 'container',
					layout:{
						type:'vbox',
						align:'stretch'
					},
					defaults: {
						layout: 'column',
						defaults: {
							readOnly: true,
							labelAlign: 'top',
							fieldCls: 'text-readonly',
							margin: 5,
							labelWidth: 100,
							columnWidth: 0.5
						}
					},
					items:[{
						xtype:'container',
						items:[{
							xtype: 'textfield',
							fieldLabel: '提出人',
							name: 'raiseBy'
						},{
							xtype: 'textfield',
							fieldLabel: '问题来源',
						    name: 'issueSourceTitle'
						}]
					},{
						xtype:'container',
						items:[{
							xtype: 'textfield',
							fieldLabel: '项目',
						    name: 'programCode'
						}, {
							xtype: 'textfield',
							fieldLabel: '车型',
						    name: 'vehicleCode'
						}]
					},{
						xtype:'panel',
						items:[{
							xtype: 'textfield',
							fieldLabel: '当前任务责任人',
							name: 'taskOwner'
						},{
							xtype: 'textfield',
							fieldLabel: '完成状态',
							name: 'statusName'
						}]
					},{
						xtype:'container',
						items:[{
							xtype: 'datefield',
							fieldLabel: '计划完成日期',
							name: 'dueDate',
							format: 'Y-m-d'
	                    },{
	                    	xtype: 'datefield',
							fieldLabel: '实际完成日期',
							name: 'complete_date',
							format: 'Y-m-d'
						}]
					},{
						xtype:'container',
						items:[{
							xtype:'counterTextArea',
							columnWidth: 1,
							name:'issueDescription',
							letterPadding: 2,
							enforceMaxLength:true,
							maxLength:500,
							fieldLabel:'问题描述'
						}]
					},{
						xtype:'container',
						items:[{
							xtype:'counterTextArea',
							columnWidth: 1,
							name:'issueCause',
							letterPadding: 2,
							enforceMaxLength:true,
							maxLength:500,
							fieldLabel:'备注'
						}]
					}]
				}]
			}],
			tbar: [{
				xtype: 'form',
		    	margin: 2,
		    	layout:{
					type:'vbox',
					align:'stretch'
				},
				width: '100%',
				items: [{
					xtype: 'fieldset',
					flex:1,
			    	title: '<B>高级查询</B>',
			    	titleAlign: 'right',
			    	collapsible:true,
			    	collapsed: true,
			    	margin: 2,
			    	layout: 'fit',
			    	items: [{
			    		xtype: 'panel',
			    		layout: {
			    			type:'vbox',
							align:'stretch'
			    		},
			    		defaults: {
			    			margin: 5,
			    			flex: 1,
			    			layout: {
				    			type:'hbox',
								align:'stretch'
				    		}
			    		},
			    		items: [{
			    			xtype: 'panel',
				    		items: [{
				    			xtype: 'combo',
				    			fieldLabel: '平台项目',
				    		    name: 'searchProgram',
				    		    store: programStore,
				    		    queryMode: 'local',
				    		    displayField: 'programCode',
				    		    valueField: 'id',
				    		    forceSelection: true,
				    		    width: 400,
				    			listeners: {
				    				change: function(combo, newValue, oldValue, eOpts) {
				    					vehicleStore.load({params:{programId: newValue}});
				    				}
				    		    }
				    		},{
				    		    xtype: 'combo',
				    		    margin: '0 0 0 20',
				    		    labelAlign: 'right',
				    			fieldLabel: '车型',
				    		    name: 'searchVechile',
				    		    store: vehicleStore,
				    		    queryMode: 'local',
				    		    displayField: 'vehicleCode',
				    		    valueField: 'id',
				    		    forceSelection: true
				    		}]
			    		},{
			    			xtype: 'panel',
				    		items: [{
				    			xtype: 'displayfield',
				    			value: '进度状态:'
				    		},{
				    			xtype:'checkbox',
								name:'searchProgress_1',
								checked: true,
								margin: '0 0 0 10',
								labelWidth: 40,
								labelSeparator: '',
								fieldLabel:'正常'
			    			},{
			    				xtype:'checkbox',
								name:'searchProgress_2',
								checked: true,
								margin: '0 0 0 10',
								labelWidth: 40,
								labelSeparator: '',
								fieldLabel:'黄灯'
			    			},{
			    				xtype:'checkbox',
								name:'searchProgress_3',
								checked: true,
								margin: '0 0 0 10',
								labelWidth: 40,
								labelSeparator: '',
								fieldLabel:'红灯'
				    		}]
			    		},{
			    			xtype: 'panel',
				    		items: [{
				    			xtype: 'displayfield',
				    			value: '问题状态:'
				    		},{
				    			xtype:'checkbox',
								name:'searchWaiting',
								checked: true,
								margin: '0 0 0 10',
								labelWidth: 40,
								labelSeparator: '',
								fieldLabel:'等待中'
					    	},{
								xtype:'checkbox',
								name:'searchProcessing',
								checked: true,
								margin: '0 0 0 10',
								labelWidth: 40,
								labelSeparator: '',
								fieldLabel:'处理中'
				    		}]
			    		},{
			    			xtype: 'panel',
				    		items: [{
				    			xtype: 'textfield',
								name: 'searchIssueTitle',
								fieldLabel: '问题标题'
				    		}]
			    		}]
			    	}]
				},{
					xtype: 'container',
					margin: 5,
		    		layout:{
						type:'hbox',
						align:'stretch'
					},
					items: [{
						xtype : 'numberfield',
						fieldLabel : '近',
						name:'searchDaysVal',
						labelAlign: 'right',
						labelWidth: 10,
						width: 100,
//						value: 7,
						listeners: {
		    				change: function(text, newValue, oldValue, eOpts) {
		    					if (newValue != null && newValue != '') {
		    						var form = me.down('toolbar').down('form').getForm();
		    						form.findField('searchDueDateTo').setValue(null);
		    					}
		    				}
		    		    }
					},{
						xtype: 'displayfield',
		    			value: '天'
					},{
						xtype:'checkbox',
						name:'searchExpired',
						margin: '0 0 0 20',
						labelWidth: 60,
						checked: true,
						labelSeparator: '',
						fieldLabel:'过期任务'
					},{
						xtype: 'datefield',
						margin: '0 0 0 20',
						format: 'Y/m/d',
						name: 'searchDueDateTo',
						labelAlign: 'right',
						fieldLabel:'计划完成日期',
						listeners: {
		    				change: function(df, newValue, oldValue, eOpts) {
		    					if (newValue != null && newValue != '') {
		    						var form = me.down('toolbar').down('form').getForm();
		    						form.findField('searchDaysVal').setValue(null);
		    					}
		    				}
		    		    }
					},{
						xtype: 'button',
						margin: '0 0 0 20',
						text: '查询',
						iconCls: 'x-fa fa-search',
						handler: 'search'
					},{
						xtype: 'button',
						margin: '0 0 0 5',
						text: '重置',
						iconCls: 'x-fa fa-rotate-left',
						handler: 'reloadSearch'
			    	},{
			    		xtype: 'button',
						text: '移交',
						margin: '0 0 0 5',
						iconCls: 'fa fa-share',
						handler: 'transferTask'
					}]
				}]
			}]
		}];
		this.callParent();
	}
});

