/**
 * 项目管理-	xx项目-状态报告Controller
 */
Ext.define('ExtApp.view.projectmanagement.report.ProjectDBStatusReportController', {
    extend: 'ExtApp.view.common.BaseViewController',
    alias: 'controller.projectDBStatusReport',
    
    init: function() {
    	var me = this;
//    	// 编辑项目状态权限控制
//    	ExtApp.util.Util.setPrivilegeByItem(
//    			this.view.down('toolbar'),
//    			this.view.projectPrivilege[this.view.programVehicleId]);
    	
    	// 时程表数据取得
		// Resource Store
		var rs = Ext.create('ExtApp.store.projectmanagement.ProgressReportResourceStore');
    	rs.getProxy().extraParams = {vehicleId: this.view.programVehicleId};
    	rs.load();
		// Events Store
    	var es = Ext.create('ExtApp.store.projectmanagement.ProgressReportEventStore');
    	es.getProxy().extraParams = {
    		programId: this.view.programId, vehicleId: this.view.programVehicleId};
    	es.load();
	
		// Project Store
		var ps = Ext.create('ExtApp.store.projectmanagement.ProgressReportProjectStore');
		ps.load();
		ps.on('load', function() {
			if (this.getAt(0).data.start == null) {
				return;
			}
			var stages = this.getAt(0).data.stages;
			for (var i = 0; i < stages.length; i++) {
				stages[i].start = new Date(Date.parse(stages[i].start.replace(/-/g,"/")));
			}
			var newView = Ext.create({
	            xtype : 'timelinepanel',
	            timeAxis : {
	                xclass : 'ExtApp.data.TimeAxis',
	                project: this.getAt(0).data
	            },
	            viewPreset: 'progress',
	            startDate: this.getAt(0).data.start,
	            endDate: this.getAt(0).data.end,
	            resourceStore   : rs,
	            eventStore      : es,
	            showTodayLine: true,
	            readOnly: true,
	            columns : [
                    {
                        xtype     : 'progressHeadercolumn',
                        dataIndex : 'Name',
                        tdCls     : 'rowbottomline',
                        width     : 80,
                        flex      : 1,
                        height    : 30
                    }
                ]
	        });
			var processPanel = me.lookupReference('refProcessReport');
			if(processPanel){
				processPanel.add(newView);
			}
		});
    },

    onSeriesTooltipRender: function (tooltip, record, item) {
        tooltip.setHtml(record.get('os') + ': ' + record.get('data1') + '%');
    },

    onSeriesTooltipRender01: function (tooltip, record, item) {
        tooltip.setHtml(record.get('os') + ': ' + record.get('data1') + '%');
    },

    //编辑状态
    editStatusReport: function() {
    	var gridData = this.lookupReference('refDBStatusReport').getStore().getAt(0).data;
    	Ext.create({
			title:"编辑项目状态",
        	xtype: 'projectDBStatusReport01',
        	statusReportData: gridData,
        	parentCaller: this
        }).show();
    },
    
    // 刷新
    refreshView: function() {
    	this.view.down('grid').store.reload();
    }

});
