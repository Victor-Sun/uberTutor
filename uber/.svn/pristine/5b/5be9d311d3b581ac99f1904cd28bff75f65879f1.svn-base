/**
 * 部门管理-部门自建任务-论坛成员组件
 */
Ext.define('ExtApp.view.deptworkspace.deptissue.DeptIssueMemberController',{
    extend: 'Ext.app.ViewController',
    alias: 'controller.deptIssueMember',
    
	// 增加
    addMember: function() {
    	var me = this;
    	Ext.create({
    		xtype: 'sysUserDepartment',
    		title: '知会',
    		multiSelect: true,
    		parentCaller: me
    	}).show();
    },
    
    // 增加 - 确定
    confirmUser: function(userData) {
		var grid = this.view.down('grid');
    	var me = this;
    	var modelData = [];
    	for (var i = 0; i < userData.length; i++) {
    		modelData.push(userData[i].data);
    	}
    	me.view.mask('Please Waiting...');
    	Ext.Ajax.request({
    		url: '/pdms/dws/dept-issue!addDeptIssueMember.action',
			params:{
				issueId: me.view.issueId,
				model: Ext.encode(modelData)
			},
			scope: me,
			success: function(response, opts) {
				me.view.unmask();
		    	var obj = Ext.decode(response.responseText);
				if (obj.success) {
					var intId = grid.getStore().getCount();
			    	Ext.each(modelData, function (record) {
			    		var valId = record.id;
			    		var valName = record.name;
			    		var gridStore = grid.getStore();
			    		if (gridStore.find('userName', valId) == -1) {
			        		if (intId != 0) {
			        			intId = intId + 1;
			        		}
			    			gridStore.insert(intId, {
				    			id : valId,
				    			userName : valName,
				    			createDate:new Date()
			        		});
			    		} else {
			    	    	ExtApp.util.Util.showToast(Ext.String.format('员工[' + valName + ']已选择!.........'));
			    		}
					});
				} else {
		        	ExtApp.util.Util.handleRequestFailure(response);
		        }
		    },
			failure: function(response, opts) {
				me.view.unmask();
		    	ExtApp.util.Util.handleRequestFailure(response);
		    }
    	});
	},
	
    // 刷新
    onResetClick: function() {
    	var me = this;
        this.view.down('grid').getStore().load({params:{issueId:me.view.issueId}});
    }
});