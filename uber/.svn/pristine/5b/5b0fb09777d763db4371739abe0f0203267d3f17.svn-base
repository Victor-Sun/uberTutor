/**
 * 项目管理-项目模板库(主计划)Controller
 */
Ext.define('ExtApp.view.projectmanagement.templatelibrary.TemplateLibraryOneController',{
    extend: 'Ext.app.ViewController',
    alias: 'controller.templateLibraryOne',

    // 点击菜单动作
    onSelectionchange: function(tree, node) {
		var refs = this.getReferences();
        var mainCard = refs.mainCardPanel;
        var lastView = mainCard.getLayout().getActiveItem();
        if (lastView != null) {
        	lastView.destroy();
        }

        if (node[0]) {
        	var newView;
	        if("MAINNODE_NODE" == node[0].get('type') || "MAINNODE_SOPNODE"== node[0].get('type') || "MAINNODE_ROOT" == node[0].get('type')) {
	        	var programId = node[0].get('id').substring(0,node[0].get('id').indexOf('_'));
	        	 newView = Ext.create({
	             	xtype: 'projectTemplateMainNode',
	             	title: node[0].get('text'),
	             	programId: programId
	             });
	        } else if("GATE_NODE" == node[0].get('type') || "GATE_ROOT" == node[0].get('type')) {
	        	var programId = node[0].get('id').substring(0,node[0].get('id').indexOf('_'));
	        	newView = Ext.create({
	             	xtype: 'projectTemplateGateNode',
	             	title: node[0].get('text'),
	             	programId: programId
	             });
	        } else if("ORG_NODE" == node[0].get('type')) {
	        	newView = Ext.create({
	             	xtype: 'projectTemplateOrgNode',
	             	title: node[0].get('text'),
	             	obsId: node[0].get('id')
	             });
	       	     newView.load({
	     		 	url: '/pdms/pm/project-temp!getProjectTemplateOrgNode.action',
	 			 	params: {
	 					id: node[0].get('id')
	 			 	}
	 			 });
	        } else if("PROGRAM" == node[0].get('type')) {
	        	newView = Ext.create({
	             	xtype: 'projectTemplate',
	             	title: node[0].get('text'),
	             	obsId: node[0].get('id')
	             });
	        	 newView.load({
	     		 	url: '/pdms/pm/project-temp!getProjectTemplateForm.action',
	 			 	params: {
	 					id: node[0].get('id')
	 			 	}
	 			 });
	        } else if("SWIMLANE_NODE" == node[0].get('type')) {
	        	 newView = Ext.create({
		             	xtype: 'projectTemplateMainDept',
		             	title: node[0].get('text'),
		             	programId: node[0].get('programObsId')
		             });
	        } else if("SWIMLANE_ROOT" == node[0].get('type')) {
	        	var programId = node[0].get('id').substring(0,node[0].get('id').indexOf('_'));
	        	 newView = Ext.create({
		             	xtype: 'projectTemplateSwimLane',
		             	title: node[0].get('text'),
		             	programId: programId,
		             	grade: '1'
		             });
	        } else if("SWIMLANE" == node[0].get('type')) {
	        	 newView = Ext.create({
		             	xtype: 'projectTemplateSwimLane',
		             	title: node[0].get('text'),
		             	programId: node[0].get('programObsId'),
		             	grade: '2'
		             });
	        }
	        if (newView) {
	        	mainCard.add(newView);
		        Ext.suspendLayouts();
		        mainCard.getLayout().setActiveItem(newView);
		        Ext.resumeLayouts(true);
	        }
        }
	},

	// tree点击右键
	showMenu: function(tree, record, item, index, e, eOpts) {
		var me = this;
		e.preventDefault();  
        e.stopEvent();
		if ("PROGRAM" == record.get('type')) {
			var m1 = new Ext.menu.Menu({
				items: [{
					text: '导入模板',
					listeners: {
						click: function() {
							me.importTemplate(record);
						}
					}
//				},{
//					text: '导出模板',
//					listeners: {
//						click: function() {
//							me.exportTemplate(record);
//						}
//					}
				},{
					text: '删除模板',
					listeners: {
						click: function() {
							me.deleteTemplate(record);
						}
					}
				}]
			});
			m1.showAt(e.getXY());
		}
	},

	// 添加模板
	importTemplate: function (record) {
		var view = this.getView();
    	this.dialog = view.add({
    		xtype: 'createProgramTemplate',
    		title: '模板导入',
    		programId: record.get('id')
    	});
    	this.dialog.show();
	},
	
	// 导出模板
	exportTemplate: function(record) {
		window.location.href = "/pdms/pm/project-temp!exportTemplate2Excel.action?"
				+ "programTempId=" + record.get('id')
				+ "&programTempName=" + record.get('text');
	},

	// 删除模板
	deleteTemplate: function (record) {
		var me = this;
    	Ext.MessageBox.confirm('提示', '您确定要删除该模板信息吗?', function(btn) {
    		// 提示信息点击【YES】则删除
    		if (btn == 'yes') {
    	    	Ext.Ajax.request({
    	    		url:'/pdms/pm/project-temp!DeleteTemplate.action',
    	    		params: {
    	    			programId: record.get('id')
    				},
    				scope: me,
    				success: function(response, opts) {
    			    	ExtApp.util.Util.showToast("删除成功！");
    					var templateTree = me.view.down('treepanel');

    					var templateStore = Ext.create(
    						'ExtApp.store.projectmanagement.ProjectTemplateLibraryStore');
    					templateStore.getProxy().extraParams = {programTypeId: me.view.programTypeId};
    					templateStore.load();
    					templateStore.on('load', function() {
    						templateTree.setStore(this);
    			    	});
    			    },
    				failure: function(response, opts) {
    			    	ExtApp.util.Util.handleRequestFailure(response);
    			    }
    	    	})
    		}
    	});
	},

	onBeforeitemexpand: function (node , eOpts) {
		var treeSp = this.view.down('treepanel').store.getProxy();
		treeSp.extraParams = {nodeType: node.data.type, programTempId: node.data.programTempId, programObsId: node.data.programObsId};
	},

	// 添加项目
	add: function() {
		this.dialog = this.view.add({
			title:"项目模板维护",
            xtype: 'projectTemplateAdd'
        });
        this.dialog.show();
    },
    
    // 一级导入文件
    onClickAttachmentOne: function() {
    	this.newWin = this.view.add({
			title:"导入模板",
        	xtype: 'projectTemplateAttachment',
        	programTypeId: this.view.programTypeId
        });
    	this.newWin.show();
    }

});