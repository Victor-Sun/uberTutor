/**
 * 质量问题管理-我的待办-效果确认Controller
 */
Ext.define('ExtApp.view.qualityissuemanagement.qedashboard.step13.MyTaskInfo13Controller', {
    extend: 'ExtApp.view.common.IssueStepViewController',
    alias: 'controller.myTaskInfo13',

    target: null,

    //初期加载
    init: function() {
    	var me = this;
    	var form = this.lookupReference('refVerificationScheme07');
    	form.load({
            url:'/pdms/ims/my-task!getVerificationLine.action',
			params: {
				keyId: this.view.keyId,
	    		formKey: this.view.formKey
			},
            success: function(form,result,data) {
    			Ext.each(result.result.data, function (record) {
    				me.addPanel(record);
    			});
            }
        });
    },
    //加载验证方案
    addPanel: function (record) {
    	var refPanel = this.lookupReference('refVerificationScheme07');
		var fieldlabelIndex = refPanel.items.length + 1;
		// 只读标志
		var readOnlyFlg = false;

		if (this.view.editFlg == true) {
			readOnlyFlg = true;
		};
		var configItem=[{
			xtype:'fieldset',
			title:'<B>验证方案 '+ fieldlabelIndex +'</B>',
			collapsible: true,
			scrollable: true,
			margin: 5,
			layout:{
				type:'vbox'
			},
			defaults: {
				layout: 'hbox',
				defaults: {
					margin: 5
				}
			},
			items:[{
				xtype:'container',
				items:[{
					xtype:'combo',
					fieldLabel:'验证方案' + fieldlabelIndex,
					readOnly:true,
					bind:{
						store:'{verification}'
					},
					queryMode:'local',
					displayField:'name',
					valueField:'id',
					name:'verification',
					value:record.verification
				},{
					xtype:'textareafield',
					fieldLabel:'通过要求',
					maxLength: 35,
					enforceMaxLength: true,
					readOnly:true,
					width: 560,
					readOnly:true,
					name:'passRequest',
					value:record.passRequest
				}]
			},{
				xtype: 'container',
				items: [{
					xtype:'textareafield',
					fieldLabel:'实施信息',
					width: 845,
					readOnly:true,
					name:'implementVehicle',
					value:record.implementVehicle
				},{
					xtype:'textfield',
					hidden:true,
					readOnly:true,
					name:'uid',
					value:record.uid
				}]
			},{
				xtype:'container',
				items:[{
					xtype:'textfield',
					fieldLabel:'验证部门',
					readOnly:true,
					name:'deptName',
					value:record.deptName
				},{
					xtype:'textfield',
					fieldLabel:'验证工程师',
					readOnly:true,
					name:'verificationEngineerName',
					value:record.verificationEngineerName
				}]
			},{
				xtype: 'container',
				items: [{
					xtype:'textareafield',
					fieldLabel:'验证效果',
					width: 845,
					readOnly:true,
					name:'verificationResult',
					value:record.verificationResult
				}]
			},{
				xtype: 'container',
				items: [{
					xtype:'imsFileAttachment',
					margin: '5 5 5 0',
					scrollable: 'y',
					programId: null,
		    		sourceType: 'SOURCE_TYPE_RESULT_ATTACHMENT',
		    		sourceId: record.uid,
		    		editable: false
				}]
			}]
		}];
		refPanel.add(configItem[0]);
    },
    // 点击【申请关闭】
    distribution : function(btn) {
    	var me = this;
    	var v_form = me.view.getForm();
    	var isOnline = v_form.findField('isOnlineStep_12').getValue().isOnlineStep_12;
    	if(isOnline == 'N'){
        	var offlineAttachmentStore = me.lookupReference('refOfflineAttachment').down('grid').getStore();
        	if(offlineAttachmentStore.getCount() < 1){
        		Ext.Msg.alert('提示', "线下流程必须上传附件！");
        		return;
        	}
    	}
    	if(v_form.isValid() == false){
    		Ext.Msg.alert('提示', "请填写必填项！！！");
    		return;
    	}
    	v_form.submit({
    		url: '/pdms/ims/ims-issue!save.action',
            params: {
            	model: Ext.encode(v_form.getFieldValues()),
//            	keyId: me.view.keyId,
//            	formKey: me.view.formKey,
//            	taskId: me.view.taskId,
//            	ProcessInstanceId: me.view.ProcessInstanceId,
            	method:'updateIssue',
            	action:'NEXT'
            },
    	    waitMsg : '正在提交数据',
    	    waitTitle : '提示',
    	    method : "POST",
    	    success : function(form, action) {
    	    	var gridTask = me.getView().grid.getStore().load();
    	    	me.getView().close();
    	    },
    	    failure : function(form, action) {
    	    	ExtApp.util.Util.handleFormFailure(action);
    	    }
	    });
    },
    // 点击【验证NG】
    typeNG : function(btn) {
    	var me = this;
    	var v_form = me.view.getForm();
    	
    	var effectConfirmation = v_form.findField('effectConfirmation');
    	effectConfirmation.allowBlank = true;
    	var reason = v_form.findField('reason');
    	reason.allowBlank = true;
    	var ecoNo = v_form.findField('ecoNo');
    	ecoNo.allowBlank = true;
//    	var lineMgr = v_form.findField('lineMgr07');
//    	lineMgr.allowBlank = true;
//    	var sectionMgr = v_form.findField('sectionMgr07');
//    	sectionMgr.allowBlank = true;
//    	var vse = v_form.findField('vse07');
//    	vse.allowBlank = true;
    	
    	var returnReasonWindow = Ext.create('ExtApp.view.common.ReturnReasonWindow',{
			callback:function(returnComment){
        		if(returnComment == null || returnComment == ''){
        			Ext.Msg.alert('提示', '必须添加备注！');
        			return;
        		}
        		returnReasonWindow.close();
				me.getView().mask('正在提交... 请耐心等待...');
				v_form.submit({
		    		url: '/pdms/ims/ims-issue!save.action',
		            params: {
		            	returnComment:returnComment,
		            	method:'updateIssue',
		            	action:'RETURN'
		            },
		    	    waitMsg : '正在提交数据',
		    	    waitTitle : '提示',
		    	    method : "POST",
		    	    success : function(form, action) {
		    	    	var gridTask = me.getView().grid.getStore().load();
		    	    	me.getView().close();
		    	    },
		    	    failure : function(form, action) {
		    	    	ExtApp.util.Util.handleFormFailure(action);
		    	    }
			    });
			}
		});
    	returnReasonWindow.show();
		return;
    },
	// 点击【效果确认】
    selcombo: function(combo, newValue, oldValue, eOpts) {
    	var me = this;
    	var v_form = me.view.getForm();
    	var effectConfirmationfield = v_form.findField('effectConfirmation');
    	var reasonField = v_form.findField('reason');
    	if(newValue == "EFFECT_CONFIRMATION_1"||newValue == "验证通过"){
    		effectConfirmationfield.setValue("EFFECT_CONFIRMATION_1");
    		reasonField.allowBlank = true;
    	}else{
    		effectConfirmationfield.setValue("EFFECT_CONFIRMATION_2");
    		reasonField.allowBlank = false;
    	};
    },
    //审核&&批准
    selectMember: function(v) {
    	var me = this;
    	this.target = v.getTarget().name;
//    	this.dialog = me.add({
//			title:"请选择...",
//        	xtype: 'myTaskInfo04SelectWindow',
//        	Target: target,
//        	formKey: this.view.formKey
//        });
    	this.dialog = me.view.add({
    		xtype: 'sysUserDepartment',
    		parentCaller: this
    	});
        this.dialog.show();
    },
    // 添加用户/选择专业经理 - 确定
    confirmUser: function(userData) {
    	var me = this;
    	var v_form = me.view.getForm();
    	var Target = this.target;
    	//审核人
    	var lineMgr = v_form.findField('lineMgr07');
    	//审核人ID
    	var lineMgrId = v_form.findField('lineMgrId07');
    	//批准人
    	var sectionMgr = v_form.findField('sectionMgr07');
    	//批准人ID
    	var sectionMgrId = v_form.findField('sectionMgrId07');
    	//07复审人
//    	var vse = me.getForm().findField('vse07');
    	//07复审人ID
//    	var vseId = me.getForm().findField('vseId07');
    	
    	if(Target == "lineMgr07"){
			lineMgr.setValue(userData.name);
			lineMgrId.setValue(userData.id);
		}else if(Target == "sectionMgr07"){
			sectionMgr.setValue(userData.name);
			sectionMgrId.setValue(userData.id);
//		}else if(Target == "vse07"){
//			vse.setValue(userData.name);
//			vseId.setValue(userData.id);
		}
    },
	// 点击【线上线下】
    isOnline: function(th, newValue, oldValue, eOpts) {
    	var me = this;
    	var v_form = me.view.getForm();
    	var isOnline = v_form.findField('isOnlineStep_12');
    	if(newValue.isOnlineStep_12 == "Y"){
    		me.lookupReference('refOfflineAttachment').hide();
    	}else{
    		me.lookupReference('refOfflineAttachment').show();
    	};
    }
});