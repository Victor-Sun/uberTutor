/**
 * 项目管理-vehicle Open Issue （根）View
 */
Ext.define('ExtApp.view.projectManagement.issue.ProjectVehicleOpenIssue',{
	extend:'Ext.panel.Panel',
	xtype:'projectVehicleOpenIssue',

	controller: 'projectVehicleOpenIssue',
	layout:{
		type:'vbox',
		align:'stretch'
	},
	
	initComponent: function() {
		var openIssueStore = Ext.create('ExtApp.store.projectmanagement.ProjectVehicleOpenIssueStore');
		openIssueStore.getProxy().extraParams = {programVehicleId: this.programVehicleId};
		openIssueStore.load();
		var issueStatisticForm = Ext.create('ExtApp.view.projectManagement.issue.IssueStatisticForm',{url:'/pdms/pm/project-open-issue!getIssueStatisticByVehicle.action'});
		issueStatisticForm.load({params:{programVehicleId: this.programVehicleId}});
		
		var projectVehicleOpenIssueLineChart = Ext.create('ExtApp.view.projectManagement.issue.ProjectVehicleOpenIssueLineChart',{programVehicleId: this.programVehicleId});
		this.items = [{
			xtype: 'tabpanel',
			layout:'fit',
			defaults:{
				scrollable:'y'
			},
			items: [{
				xtype:'panel',
				title: 'Open Issue',
				items:[issueStatisticForm,{
					xtype:'grid',
					height:Ext.getBody().getViewSize().height-150,
					store: openIssueStore,
					columns:[{
						xtype: 'rownumberer'
					},{
						text: '新提醒',
						width: 60,
						dataIndex: 'isNew',
						renderer: 'isNew',
						align: 'center'
					},{
						text:'进度状态',
						width: 80,
						dataIndex:'progressStatus',
						renderer: 'renderIssueProgress',
						align: 'center'
					},{
						text:'问题标题',
						width:120,
						dataIndex:'issueTitle'
					},{
						text:'问题来源',
						width:120,
						dataIndex:'issueSourceTitle'
					},{
						text:'提出人',
						width: 100,
						dataIndex:'raiseByName'
					},{
						text:'提出日期',
						width: 100,
						dataIndex:'raiseDate'
					},{
						text:'所属项目',
						width: 150,
						dataIndex:'programCode'
					},{
						text:'所属车型',
						width: 150,
						dataIndex:'vehicleCode'
					},{
						text:'责任组',
						width: 120,
						dataIndex:'respObsName'
					},{
						text:'责任人',
						width: 100,
						dataIndex:'respUserName'
					},{
						text:'当前任务负责人',
						width: 130,
						dataIndex:'taskOwner'
					},{
						text:'完成状态',
						width: 80,
						dataIndex:'statusCodeName'
					},{
						text:'计划完成日期',
						width: 120,
						dataIndex:'dueDate'
					},{
						text:'实际完成日期',
						width: 120,
						dataIndex:'actualFinishDate'
					},{
						text:'计划偏离天数',
						dataIndex:'daysDelayed',
						width:150
					},{
						text:'优先级',
						dataIndex:'issuePriorityName', 
						width: 100
			        },
					{ xtype:'actioncolumn',
			            width:50,
			            items: [{
			            	iconCls:'x-fa fa-trash',
			                tooltip: 'Delete',
			                handler: function(grid, rowIndex, colIndex) {
			                	 var rec = grid.getStore().getAt(rowIndex);
			                	 var id = rec.get('id');
			                	 Ext.Ajax.request({
			                		 url: '/pdms/pm/project-open-issue!deleteOpenIssue.action',
			                		 params:{id:id},
			                	     success: function(response, opts) {
			                	    	 var result = ExtApp.util.Util.decodeJSON(response.responseText);
			                	 		 if (!result){ //#4
			            	    	 		 result = {};
			            	    	 		 result.success = false;
			            	    	 		 result.msg = response.responseText;
			                	 		 }
			                	 		 openIssueStore.load();
			                	     },

			                	     failure: function(response, opts) {
			                	    	 var result = ExtApp.util.Util.decodeJSON(response.responseText);
			                	 		 
			                	     }
			                	 });
			                }
			            }]
			        }],
					listeners:{
			        	celldblclick: 'onCelldblclick'
					},
					tbar: [{
			            text: '提出问题',
			            itemId: 'btnRaiseIssue',
			            handler: 'raiseIssue'
			        },{
			            text: '导出Excel',
			            handler: 'exportExcel'
			        }],
					dockedItems: [{
						xtype: 'pagingtoolbar',
						dock: 'bottom',
						displayInfo: true,
						store: openIssueStore
					}]
				}]
			},projectVehicleOpenIssueLineChart]
		}];
		this.callParent(arguments);
	}
});